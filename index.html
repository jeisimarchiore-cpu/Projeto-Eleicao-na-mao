<!DOCTYPE html>
<html lang="pt-br" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Colaborativo de Igrejas - Blumenau</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet.js (CSS e JS) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet.awesome-markers (Ícones) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
    
    <!-- Font Awesome (Ícones) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Estilos personalizados para complementar o Tailwind e o Leaflet */
        .leaflet-popup-content-wrapper {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
        }
        .leaflet-popup-content {
            padding: 16px;
        }
        .leaflet-popup-content h3 {
            font-size: 1.25rem; /* Aumentado */
            font-weight: 700; /* Mais forte */
            margin-bottom: 12px;
            color: #111827;
        }
        .leaflet-popup-content p {
            margin: 6px 0;
            font-size: 0.95rem; /* Levemente maior */
            color: #374151;
            display: flex;
            align-items: center;
        }
        .leaflet-popup-content strong {
            color: #1f2937;
        }
        #map-container {
             cursor: grab;
        }
        .leaflet-grabbing #map-container {
            cursor: grabbing;
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #a1a1aa;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #71717a;
        }
        .schedule-day-fields { display: none; }
        .schedule-day-fields.active { display: block; }

        /* Animação para o painel lateral */
        #side-panel {
            transition: transform 0.3s ease-in-out;
        }
        #side-panel.closed {
            transform: translateX(100%);
        }
        
        /* Estilos para o Modo Inspeção */
        #inspect-mode-btn.active {
            background-color: #2563eb; /* bg-blue-600 */
            color: white;
        }
        body.inspect-mode-active #map-container {
            cursor: crosshair;
        }
    </style>
</head>
<body class="h-full bg-gray-100 antialiased overflow-hidden">

    <div id="app-container" class="relative h-full w-full">
        <!-- O Contêiner do Mapa -->
        <div id="map-container" class="h-full w-full"></div>

        <!-- Overlays do Mapa (Controles, Pesquisa, etc.) -->
        <div class="absolute top-0 left-0 p-2 md:p-4 z-[999] w-full md:w-auto">
            <div class="bg-white/90 backdrop-blur-sm p-2 rounded-xl shadow-lg flex items-center space-x-2 w-full md:max-w-md">
                <i class="fa fa-search text-gray-400 px-2"></i>
                <input type="text" id="search-input" placeholder="Pesquisar por nome, líder ou bairro..." class="w-full bg-transparent focus:outline-none text-gray-800 placeholder-gray-500">
                <button id="clear-search-btn" class="hidden text-gray-500 hover:text-gray-800 pr-2">
                    <i class="fa fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Controles do Mapa (à direita) -->
        <div class="absolute top-4 right-4 z-[999] flex flex-col space-y-2">
             <button id="toggle-panel-btn" class="bg-white/90 backdrop-blur-sm w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-gray-800 hover:bg-gray-200 transition" title="Adicionar com Formulário Vazio">
                <i class="fa fa-plus text-lg"></i>
            </button>
            <button id="inspect-mode-btn" class="bg-white/90 backdrop-blur-sm w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-gray-800 hover:bg-gray-200 transition" title="Adicionar Igreja pelo Mapa (Modo Inspeção)">
                <i class="fa fa-crosshairs text-lg"></i>
            </button>
        </div>

        <div class="absolute bottom-10 right-4 z-[999] flex flex-col space-y-2">
            <button id="user-location-btn" class="bg-white/90 backdrop-blur-sm w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-blue-600 hover:bg-gray-200 transition" title="Minha Localização">
                <i class="fa fa-location-crosshairs text-lg"></i>
            </button>
        </div>
        
        <!-- Contador de Igrejas (à esquerda, inferior) -->
        <div id="church-counter" class="absolute bottom-4 left-4 z-[999] bg-white/90 backdrop-blur-sm py-2 px-4 rounded-lg shadow-lg cursor-pointer hover:bg-gray-50 transition">
            <span class="text-gray-800 font-semibold">Carregando igrejas...</span>
        </div>

        <!-- Painel Lateral para Adicionar/Editar -->
        <div id="side-panel" class="absolute top-0 right-0 h-full w-full max-w-lg bg-gray-50 shadow-2xl z-[1000] flex flex-col closed">
             <div class="flex-shrink-0 bg-white/80 backdrop-blur-sm flex justify-between items-center p-6 border-b">
                <h3 id="panel-title" class="text-2xl font-bold text-gray-900">Adicionar Nova Igreja</h3>
                <button id="close-panel-btn" class="text-gray-500 hover:text-gray-900 transition-colors">
                    <i class="fa fa-times fa-xl"></i>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scrollbar p-6">
                <form id="church-form" class="space-y-5">
                    <!-- Importar do Google Maps -->
                    <div>
                        <label for="gmaps-url" class="block text-sm font-medium text-gray-700">Importar do Google Maps</label>
                        <div class="mt-1 flex rounded-lg shadow-sm">
                            <input type="url" id="gmaps-url" placeholder="Cole o link do Google Maps aqui" class="flex-1 block w-full rounded-none rounded-l-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <button type="button" id="import-gmaps-btn" title="Importar dados do link" class="inline-flex items-center px-4 rounded-r-lg border border-l-0 border-gray-300 bg-gray-100 text-gray-600 hover:bg-gray-200 transition">
                                <i class="fa fa-download"></i>
                            </button>
                        </div>
                        <div id="import-message-area" class="mt-1 text-xs h-4"></div>
                    </div>

                    <div class="relative">
                        <div class="absolute inset-0 flex items-center" aria-hidden="true">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative flex justify-center">
                            <span class="bg-gray-50 px-2 text-sm text-gray-500">ou</span>
                        </div>
                    </div>

                    <p id="coords-info" class="text-sm text-gray-700 bg-blue-50 border border-blue-200 p-3 rounded-lg text-center flex items-center justify-center"><i class="fa fa-map-pin mr-2 text-blue-500"></i>Clique no mapa ou use o CEP para localizar.</p>
                    
                    <!-- Campos do Formulário -->
                    <input type="hidden" id="church-coords-lat">
                    <input type="hidden" id="church-coords-lng">
                    
                    <div><label for="church-name" class="block text-sm font-medium text-gray-700">Nome da Igreja*</label><input type="text" id="church-name" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                    <div><label for="church-pastor" class="block text-sm font-medium text-gray-700">Líder / Pastor / Padre</label><input type="text" id="church-pastor" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="church-cep" class="block text-sm font-medium text-gray-700">CEP</label><input type="text" id="church-cep" placeholder="Apenas números" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"><div id="cep-message-area" class="mt-1 text-xs h-4"></div></div>
                        <div><label for="church-numero" class="block text-sm font-medium text-gray-700">Número</label><input type="text" id="church-numero" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                    </div>
                     <div><label for="church-bairro" class="block text-sm font-medium text-gray-700">Bairro</label><input type="text" id="church-bairro" class="mt-1 block w-full bg-gray-200 border-gray-300 rounded-lg shadow-sm sm:text-sm" readonly></div>
                    <div><label for="church-endereco" class="block text-sm font-medium text-gray-700">Endereço Completo</label><input type="text" id="church-endereco" class="mt-1 block w-full bg-gray-200 border-gray-300 rounded-lg shadow-sm sm:text-sm" readonly></div>

                    <!-- Horários -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Horários e Atividades</label>
                        <div id="horarios-container" class="space-y-3"></div>
                    </div>

                    <div><label for="church-contato" class="block text-sm font-medium text-gray-700">Telefone Fixo</label><input type="tel" id="church-contato" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                    <div><label for="church-whatsapp" class="block text-sm font-medium text-gray-700">WhatsApp</label><input type="tel" id="church-whatsapp" placeholder="(47) 9XXXX-XXXX" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                    <div><label for="church-redes" class="block text-sm font-medium text-gray-700">Rede Social (URL)</label><input type="url" id="church-redes" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                </form>
            </div>
             <div class="flex-shrink-0 bg-white/80 backdrop-blur-sm p-6 border-t mt-auto space-y-3">
                 <div id="message-area" class="text-sm text-center h-5"></div>
                 <button type="button" id="save-church-btn" class="w-full bg-blue-600 text-white py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">Adicionar Igreja</button>
                 <button type="button" id="cancel-edit-btn" style="display: none;" class="w-full bg-gray-600 text-white py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition">Cancelar Edição</button>
            </div>
        </div>

        <!-- Barra de Progresso para Escaneamento -->
        <div id="scan-progress-bar" class="absolute bottom-4 left-1/2 -translate-x-1/2 z-[999] bg-white/90 backdrop-blur-sm p-3 rounded-lg shadow-lg w-full max-w-sm hidden transition-opacity duration-300">
            <div class="flex justify-between items-center mb-1">
                <span id="scan-progress-label" class="text-sm font-semibold text-gray-700">Escaneando...</span>
                <span id="scan-progress-text" class="text-sm font-medium text-gray-600">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="scan-progress-fill" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300 ease-linear" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Modal: Lista de Igrejas -->
    <div id="church-list-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-[1001] hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-3xl m-4 flex flex-col max-h-[90vh]">
             <div class="flex justify-between items-center p-5 border-b bg-gray-50/50 rounded-t-xl">
                <h2 class="text-xl font-bold text-gray-900">Lista de Igrejas por Bairro</h2>
                <button class="modal-close-btn text-gray-500 hover:text-gray-900 transition"><i class="fa fa-times fa-lg"></i></button>
            </div>
            <div id="church-list-content" class="p-6 overflow-y-auto custom-scrollbar flex-grow"></div>
             <div class="flex justify-between items-center p-5 border-t bg-gray-50/50 rounded-b-xl">
                <span class="text-sm text-gray-700 font-medium">Funções Administrativas</span>
                <div>
                     <button id="scan-map-btn" class="bg-blue-600 text-white text-sm font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-blue-700 transition" title="Escanear mapa por novas igrejas"><i class="fa fa-search mr-2"></i>Escanear Mapa</button>
                    <button id="clear-map-btn" class="bg-red-600 text-white text-sm font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-red-700 transition ml-2" title="Apagar todos os dados do mapa"><i class="fa fa-trash-alt mr-2"></i>Limpar Mapa</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Confirmação Genérica (para Excluir, Limpar, Escanear) -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-[1002] hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md m-4 p-8 text-center">
            <h3 id="confirm-title" class="text-xl font-bold text-gray-900"></h3>
            <p id="confirm-message" class="mt-3 text-base text-gray-600"></p>
            <div id="password-field-container" class="mt-6 hidden">
                <label for="admin-password" class="sr-only">Senha de Administrador</label>
                <input type="password" id="admin-password" placeholder="Senha de Administrador" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-center">
                <p id="password-error" class="text-red-500 text-xs mt-1 h-4"></p>
            </div>
            <div class="mt-8 flex justify-center space-x-4">
                <button id="confirm-action-btn" class="px-8 py-2.5 rounded-lg text-white font-semibold"></button>
                <button id="cancel-action-btn" class="px-8 py-2.5 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/60 backdrop-blur-sm z-[2000] flex flex-col items-center justify-center">
        <i class="fa fa-church fa-spin text-5xl text-blue-600"></i>
        <p class="mt-4 text-gray-800 font-semibold text-lg">Carregando mapa...</p>
    </div>


    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, setDoc, deleteDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURAÇÃO E INICIALIZAÇÃO ---
        
        const ADMIN_PASSWORD = "2308"; // Senha para funções perigosas (somente para demonstração)
        
        // Configuração do Firebase (substituída em ambiente de produção)
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" }; // Fallback
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-map-app';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const igrejasCollectionRef = collection(db, `artifacts/${appId}/public/data/igrejas`);

        // Configurações do Mapa
        const MAP_CENTER = [-26.9194, -49.0661];
        const INITIAL_ZOOM = 13;
        const map = L.map('map-container', { zoomControl: false }).setView(MAP_CENTER, INITIAL_ZOOM);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
            maxZoom: 19, 
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>' 
        }).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        const churchIcon = L.AwesomeMarkers.icon({ icon: 'church', markerColor: 'darkred', prefix: 'fa' });
        const tempIcon = L.AwesomeMarkers.icon({ icon: 'plus', markerColor: 'blue', prefix: 'fa' });
        const churchLayer = L.layerGroup().addTo(map);

        // --- ESTADO DA APLICAÇÃO ---
        
        let allChurches = [];
        let displayedChurches = [];
        let allMarkers = [];
        let tempMarker = null;
        let editingId = null;
        let currentStreet = '';
        let isInspectMode = false;

        const DIAS_SEMANA = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];

        // --- SELETORES DE DOM ---
        
        const DOMElements = {
            loadingOverlay: document.getElementById('loading-overlay'),
            sidePanel: document.getElementById('side-panel'),
            togglePanelBtn: document.getElementById('toggle-panel-btn'),
            closePanelBtn: document.getElementById('close-panel-btn'),
            inspectModeBtn: document.getElementById('inspect-mode-btn'),
            form: document.getElementById('church-form'),
            panelTitle: document.getElementById('panel-title'),
            saveBtn: document.getElementById('save-church-btn'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            coordsInfo: document.getElementById('coords-info'),
            messageArea: document.getElementById('message-area'),
            importMessageArea: document.getElementById('import-message-area'),
            cepMessageArea: document.getElementById('cep-message-area'),
            churchListModal: document.getElementById('church-list-modal'),
            churchListContent: document.getElementById('church-list-content'),
            churchCounter: document.getElementById('church-counter'),
            searchInput: document.getElementById('search-input'),
            clearSearchBtn: document.getElementById('clear-search-btn'),
            confirmModal: document.getElementById('confirm-modal'),
            gmapsUrlInput: document.getElementById('gmaps-url'),
            horariosContainer: document.getElementById('horarios-container'),
            scanProgressBar: document.getElementById('scan-progress-bar'),
            scanProgressLabel: document.getElementById('scan-progress-label'),
            scanProgressText: document.getElementById('scan-progress-text'),
            scanProgressFill: document.getElementById('scan-progress-fill'),
            fields: {
                lat: document.getElementById('church-coords-lat'),
                lng: document.getElementById('church-coords-lng'),
                name: document.getElementById('church-name'),
                pastor: document.getElementById('church-pastor'),
                cep: document.getElementById('church-cep'),
                numero: document.getElementById('church-numero'),
                bairro: document.getElementById('church-bairro'),
                endereco: document.getElementById('church-endereco'),
                contato: document.getElementById('church-contato'),
                whatsapp: document.getElementById('church-whatsapp'),
                redes: document.getElementById('church-redes'),
            }
        };

        // --- FUNÇÕES DE UI ---

        const UI = {
            showLoading: (message) => {
                DOMElements.loadingOverlay.classList.remove('hidden');
                DOMElements.loadingOverlay.querySelector('p').textContent = message || 'Carregando...';
            },
            hideLoading: () => DOMElements.loadingOverlay.classList.add('hidden'),
            openPanel: () => DOMElements.sidePanel.classList.remove('closed'),
            closePanel: () => DOMElements.sidePanel.classList.add('closed'),
            showMessage: (element, message, isError = false) => {
                element.textContent = message;
                element.className = `mt-1 text-xs h-4 ${isError ? 'text-red-500' : 'text-green-600'}`;
            },
            updateChurchCount: () => {
                const count = displayedChurches.length;
                const total = allChurches.length;
                let text = `<i class="fa fa-church text-gray-600 mr-2"></i><strong class="text-gray-900">${count}</strong> de <strong class="text-gray-900">${total}</strong> igreja(s)`;
                if (count !== total) {
                    text += ` (filtrado)`;
                }
                DOMElements.churchCounter.innerHTML = text;
            },
            showModal: (id) => document.getElementById(id)?.classList.replace('hidden', 'flex'),
            hideModal: (id) => document.getElementById(id)?.classList.replace('flex', 'hidden'),
            setupConfirmModal: ({ title, message, actionText, actionClass, onConfirm, requiresPassword = false, showCancelButton = true }) => {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                const actionBtn = document.getElementById('confirm-action-btn');
                actionBtn.textContent = actionText;
                actionBtn.className = `px-8 py-2.5 rounded-lg text-white font-semibold transition ${actionClass}`;
                
                const passwordContainer = document.getElementById('password-field-container');
                const passwordInput = document.getElementById('admin-password');
                const passwordError = document.getElementById('password-error');
                
                if (requiresPassword) {
                    passwordContainer.classList.remove('hidden');
                    passwordInput.value = '';
                    passwordError.textContent = '';
                } else {
                    passwordContainer.classList.add('hidden');
                }

                const cancelBtn = document.getElementById('cancel-action-btn');
                cancelBtn.style.display = showCancelButton ? 'inline-block' : 'none';

                actionBtn.onclick = () => {
                    if (requiresPassword) {
                        if (passwordInput.value === ADMIN_PASSWORD) {
                            onConfirm();
                            UI.hideModal('confirm-modal');
                        } else {
                            passwordError.textContent = 'Senha incorreta.';
                            passwordInput.focus();
                        }
                    } else {
                        onConfirm();
                        UI.hideModal('confirm-modal');
                    }
                };

                if (showCancelButton) {
                    cancelBtn.onclick = () => UI.hideModal('confirm-modal');
                }
                UI.showModal('confirm-modal');
            },
            showProgressBar: (label) => {
                DOMElements.scanProgressBar.classList.remove('hidden');
                DOMElements.scanProgressLabel.textContent = label || 'Processando...';
                UI.updateProgressBar(0);
            },
            hideProgressBar: () => {
                setTimeout(() => {
                    DOMElements.scanProgressBar.classList.add('hidden');
                }, 3000);
            },
            updateProgressBar: (percentage, label = null) => {
                const p = Math.round(percentage);
                DOMElements.scanProgressFill.style.width = `${p}%`;
                DOMElements.scanProgressText.textContent = `${p}%`;
                if (label) {
                    DOMElements.scanProgressLabel.textContent = label;
                }
            },
        };

        // --- LÓGICA DO MAPA ---
        
        const MapLogic = {
            redrawAllMarkers: () => {
                churchLayer.clearLayers();
                allMarkers = [];
                displayedChurches.forEach(church => {
                    const marker = L.marker(church.coords, { icon: churchIcon }).addTo(churchLayer);
                    marker.bindPopup(MapLogic.createPopupContent(church));
                    marker.churchId = church.id;
                    allMarkers.push(marker);
                });
                UI.updateChurchCount();
            },
            createPopupContent: (church) => {
                let content = `<h3>${church.nome}</h3>`;
                if (church.pastor) content += `<p><i class="fa fa-user mr-3 text-gray-400"></i><strong>Líder:</strong>&nbsp; ${church.pastor}</p>`;
                if (church.endereco) content += `<p><i class="fa fa-map-marker-alt mr-3 text-gray-400"></i><strong>Endereço:</strong>&nbsp; ${church.endereco}</p>`;
                
                if (church.horarios && church.horarios.length > 0) {
                    let horariosHtml = "<p><i class='fa fa-clock mr-3 text-gray-400'></i><strong>Horários:</strong></p><ul style='list-style-position: inside; padding-left: 28px; margin-top: -8px;'>";
                    DIAS_SEMANA.forEach(dia => {
                        const atividades = church.horarios.filter(h => h.dia === dia);
                        if (atividades.length > 0) {
                            horariosHtml += `<li><strong>${dia}:</strong> ${atividades.map(a => `${a.horaInicio}${a.horaFim ? ` - ${a.horaFim}`: ''} (${a.desc})`).join(', ')}</li>`;
                        }
                    });
                    content += horariosHtml + "</ul>";
                }

                if (church.contato) content += `<p><i class="fa fa-phone mr-3 text-gray-400"></i>${church.contato}</p>`;
                if (church.whatsapp) content += `<p><i class="fab fa-whatsapp mr-3 text-green-500"></i>${church.whatsapp}</p>`;
                if (church.redes_sociais) content += `<p><a href="${church.redes_sociais}" target="_blank" class="text-blue-600 hover:underline"><i class="fa fa-globe mr-3 text-gray-400"></i>Visitar Rede Social</a></p>`;
                
                content += `<div class="mt-4 pt-3 border-t flex space-x-2">
                    <button class="popup-edit-btn text-sm bg-yellow-400 text-yellow-900 font-semibold py-2 px-4 rounded-lg hover:bg-yellow-500 transition" data-id="${church.id}">Editar</button>
                    <button class="popup-delete-btn text-sm bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition" data-id="${church.id}" data-name="${church.nome.replace(/"/g, '&quot;')}">Excluir</button>
                </div>`;
                return content;
            },
            setLocationOnMap: (lat, lng, zoom = 18) => {
                DOMElements.fields.lat.value = lat.toFixed(6);
                DOMElements.fields.lng.value = lng.toFixed(6);
                if (tempMarker) map.removeLayer(tempMarker);
                const latLng = [lat, lng];
                tempMarker = L.marker(latLng, { icon: tempIcon }).addTo(map);
                map.setView(latLng, zoom);
                DOMElements.coordsInfo.innerHTML = '<i class="fa fa-check-circle text-green-500 mr-2"></i>Localização selecionada no mapa!';
            },
            findUserLocation: () => {
                if (navigator.geolocation) {
                    UI.showLoading('Obtendo sua localização...');
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            map.setView([latitude, longitude], 15);
                            L.marker([latitude, longitude]).addTo(map)
                                .bindPopup("Você está aqui!").openPopup();
                            UI.hideLoading();
                        },
                        () => {
                            UI.hideLoading();
                            UI.setupConfirmModal({
                                title: 'Erro de Localização',
                                message: 'Não foi possível obter sua localização. Verifique as permissões do seu navegador.',
                                actionText: 'OK',
                                actionClass: 'bg-red-600 hover:bg-red-700',
                                onConfirm: () => {},
                                showCancelButton: false
                            });
                        }
                    );
                } else {
                    UI.setupConfirmModal({
                        title: 'Erro de Compatibilidade',
                        message: 'A geolocalização não é suportada por este navegador.',
                        actionText: 'OK',
                        actionClass: 'bg-red-600 hover:bg-red-700',
                        onConfirm: () => {},
                        showCancelButton: false
                    });
                }
            }
        };

        // --- LÓGICA DO FORMULÁRIO ---

        const FormLogic = {
            reset: () => {
                editingId = null;
                currentStreet = '';
                DOMElements.form.reset();
                DOMElements.gmapsUrlInput.value = '';
                DIAS_SEMANA.forEach(dia => {
                    const diaId = dia.toLowerCase();
                    document.getElementById(`check-${diaId}`).checked = false;
                    document.getElementById(`fields-${diaId}`).classList.remove('active');
                });
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
                DOMElements.coordsInfo.innerHTML = '<i class="fa fa-map-pin mr-2 text-blue-500"></i>Clique no mapa ou use o CEP para localizar.';
                UI.showMessage(DOMElements.messageArea, '');
                UI.showMessage(DOMElements.importMessageArea, '');
                UI.showMessage(DOMElements.cepMessageArea, '');

                DOMElements.panelTitle.textContent = 'Adicionar Nova Igreja';
                DOMElements.saveBtn.textContent = 'Adicionar Igreja';
                DOMElements.saveBtn.className = 'w-full bg-blue-600 text-white py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition';
                DOMElements.cancelEditBtn.style.display = 'none';
                DOMElements.fields.name.placeholder = '';
            },
            startEdit: (id) => {
                const church = allChurches.find(c => c.id === id);
                if (!church) return;
                
                FormLogic.reset();
                editingId = id;
                
                DOMElements.fields.name.value = church.nome || '';
                DOMElements.fields.pastor.value = church.pastor || '';
                DOMElements.fields.bairro.value = church.bairro || '';
                DOMElements.fields.endereco.value = church.endereco || '';
                DOMElements.fields.contato.value = church.contato || '';
                DOMElements.fields.whatsapp.value = church.whatsapp || '';
                DOMElements.fields.redes.value = church.redes_sociais || '';
                DOMElements.fields.lat.value = church.coords[0];
                DOMElements.fields.lng.value = church.coords[1];

                (church.horarios || []).forEach(h => {
                    const diaId = h.dia.toLowerCase();
                    document.getElementById(`check-${diaId}`).checked = true;
                    const fieldsDiv = document.getElementById(`fields-${diaId}`);
                    fieldsDiv.classList.add('active');
                    fieldsDiv.querySelector(`#hora-inicio-${diaId}`).value = h.horaInicio || '';
                    fieldsDiv.querySelector(`#hora-fim-${diaId}`).value = h.horaFim || '';
                    fieldsDiv.querySelector(`#desc-${diaId}`).value = h.desc || '';
                });

                DOMElements.panelTitle.textContent = 'Editar Igreja';
                DOMElements.saveBtn.textContent = 'Salvar Alterações';
                DOMElements.saveBtn.className = 'w-full bg-yellow-500 text-white py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-400 transition';
                DOMElements.cancelEditBtn.style.display = 'block';
                map.closePopup();
                UI.openPanel();
            },
            save: async () => {
                if (!DOMElements.fields.name.value || !DOMElements.fields.lat.value || !DOMElements.fields.lng.value) {
                    UI.showMessage(DOMElements.messageArea, 'Nome e localização são obrigatórios.', true);
                    return;
                }
                const horarios = [];
                DIAS_SEMANA.forEach(dia => {
                    const diaId = dia.toLowerCase();
                    if(document.getElementById(`check-${diaId}`).checked) {
                        horarios.push({
                            dia: dia,
                            horaInicio: document.getElementById(`hora-inicio-${diaId}`).value,
                            horaFim: document.getElementById(`hora-fim-${diaId}`).value,
                            desc: document.getElementById(`desc-${diaId}`).value
                        });
                    }
                });
                
                const churchData = {
                    nome: DOMElements.fields.name.value,
                    pastor: DOMElements.fields.pastor.value,
                    bairro: DOMElements.fields.bairro.value,
                    endereco: DOMElements.fields.endereco.value,
                    horarios: horarios,
                    contato: DOMElements.fields.contato.value,
                    whatsapp: DOMElements.fields.whatsapp.value,
                    redes_sociais: DOMElements.fields.redes.value,
                    coords: [parseFloat(DOMElements.fields.lat.value), parseFloat(DOMElements.fields.lng.value)]
                };

                DOMElements.saveBtn.textContent = 'Salvando...';
                DOMElements.saveBtn.disabled = true;

                try {
                    if (editingId) {
                        await setDoc(doc(db, `artifacts/${appId}/public/data/igrejas`, editingId), churchData);
                    } else {
                        await addDoc(igrejasCollectionRef, churchData);
                    }
                    FormLogic.reset();
                    UI.closePanel();
                } catch (error) {
                    console.error("Erro ao salvar:", error);
                    UI.showMessage(DOMElements.messageArea, 'Erro ao salvar. Tente novamente.', true);
                } finally {
                    DOMElements.saveBtn.disabled = false;
                }
            },
            setupHorarios: () => {
                const timeOptions = (() => { let opts = '<option value="">--:--</option>'; for (let h=0;h<24;h++) for(let m=0;m<60;m+=30) {const t=`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; opts+=`<option value="${t}">${t}</option>`;} return opts; })();
                
                DIAS_SEMANA.forEach(dia => {
                    const diaId = dia.toLowerCase();
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'bg-white border border-gray-200 p-3 rounded-lg';
                    dayDiv.innerHTML = `
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="check-${diaId}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-3 text-sm font-medium text-gray-800">${dia}</span>
                        </label>
                        <div class="schedule-day-fields mt-3 space-y-2 pl-7" id="fields-${diaId}">
                            <input type="text" id="desc-${diaId}" placeholder="Descrição (Ex: Culto, Missa)" class="block w-full border-gray-300 rounded-lg shadow-sm sm:text-sm">
                            <div class="flex items-center space-x-2 text-sm">
                                <select id="hora-inicio-${diaId}" class="block w-full border-gray-300 rounded-lg shadow-sm sm:text-sm">${timeOptions}</select>
                                <span class="text-gray-500">até</span>
                                <select id="hora-fim-${diaId}" class="block w-full border-gray-300 rounded-lg shadow-sm sm:text-sm">${timeOptions}</select>
                            </div>
                        </div>
                    `;
                    DOMElements.horariosContainer.appendChild(dayDiv);
                    
                    const checkbox = dayDiv.querySelector(`#check-${diaId}`);
                    const fieldsDiv = dayDiv.querySelector(`#fields-${diaId}`);
                    checkbox.addEventListener('change', () => {
                        fieldsDiv.classList.toggle('active', checkbox.checked);
                    });
                });
            }
        };

        // --- FUNÇÕES DE API EXTERNA ---

        const API = {
            fetchAddressForCoords: async (lat, lon) => {
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data && data.address) {
                        const addr = data.address;
                        const rua = addr.road || '';
                        const numero = addr.house_number || '';
                        const bairro = addr.suburb || addr.city_district || '';
                        return {
                            endereco: numero ? `${rua}, ${numero}` : rua,
                            bairro: bairro,
                            rua: rua,
                            numero: numero
                        };
                    }
                } catch (error) {
                    console.error("Erro no reverse geocode:", error);
                }
                return { endereco: '', bairro: '', rua: '', numero: '' };
            },
            fetchCEP: async (cep) => {
                UI.showMessage(DOMElements.cepMessageArea, 'Buscando CEP...');
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();
                    if (data.erro) {
                        UI.showMessage(DOMElements.cepMessageArea, 'CEP não encontrado.', true);
                        currentStreet = '';
                    } else {
                        currentStreet = data.logradouro || '';
                        DOMElements.fields.endereco.value = currentStreet;
                        DOMElements.fields.bairro.value = data.bairro || '';
                        DOMElements.fields.numero.value = '';
                        DOMElements.fields.numero.focus();
                        UI.showMessage(DOMElements.cepMessageArea, 'CEP encontrado!');
                        API.geocodeAddress(`${currentStreet}, ${data.bairro}, Blumenau`);
                    }
                } catch {
                    UI.showMessage(DOMElements.cepMessageArea, 'Erro ao buscar CEP.', true);
                    currentStreet = '';
                }
            },
            geocodeAddress: async (address) => {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const { lat, lon } = data[0];
                        MapLogic.setLocationOnMap(parseFloat(lat), parseFloat(lon));
                    }
                } catch (error) {
                    console.error("Erro no geocode:", error);
                }
            },
            reverseGeocode: async (lat, lon) => {
                const addrDetails = await API.fetchAddressForCoords(lat, lon);
                DOMElements.fields.bairro.value = addrDetails.bairro;
                currentStreet = addrDetails.rua;
                DOMElements.fields.numero.value = addrDetails.numero;
                DOMElements.fields.endereco.value = addrDetails.endereco;
            }
        };

        // --- FUNÇÕES AVANÇADAS (ADMIN) ---

        const Admin = {
            confirmDelete: (id, name) => {
                UI.setupConfirmModal({
                    title: 'Confirmar Exclusão',
                    message: `Tem certeza que deseja excluir a igreja "${name}"? Esta ação não pode ser desfeita.`,
                    actionText: 'Sim, Excluir',
                    actionClass: 'bg-red-600 hover:bg-red-700',
                    onConfirm: async () => {
                        try {
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/igrejas`, id));
                        } catch (error) { console.error("Erro ao excluir:", error); }
                    }
                });
            },
            confirmClearMap: () => {
                UI.setupConfirmModal({
                    title: 'Limpar Todo o Mapa',
                    message: 'Esta ação é irreversível e apagará TODAS as igrejas do mapa. Para confirmar, digite a senha de administrador.',
                    actionText: 'Confirmar Limpeza',
                    actionClass: 'bg-red-600 hover:bg-red-700',
                    requiresPassword: true,
                    onConfirm: Admin.clearAllData
                });
            },
            clearAllData: async () => {
                if (allChurches.length === 0) return;
                UI.showLoading('Limpando todos os dados...');
                const batch = writeBatch(db);
                allChurches.forEach(church => {
                    batch.delete(doc(db, `artifacts/${appId}/public/data/igrejas`, church.id));
                });
                try {
                    await batch.commit();
                } catch (error) {
                    console.error("Erro ao limpar mapa:", error);
                } finally {
                    UI.hideLoading();
                }
            },
            confirmScanMap: () => {
                UI.setupConfirmModal({
                    title: 'Escaneamento Profundo',
                    message: 'Isso buscará por locais de culto em TODA a cidade de Blumenau e pode levar alguns minutos. Requer senha de administrador.',
                    actionText: 'Iniciar Escaneamento',
                    actionClass: 'bg-blue-600 hover:bg-blue-700',
                    requiresPassword: true,
                    onConfirm: Admin.scanMapForChurches
                });
            },
            findAndAddChurchFromMap: async (lat, lng) => {
                UI.showLoading('Inspecionando o mapa...');
                const query = `[out:json][timeout:10];(node(around:50, ${lat}, ${lng})["amenity"="place_of_worship"];way(around:50, ${lat}, ${lng})["amenity"="place_of_worship"];relation(around:50, ${lat}, ${lng})["amenity"="place_of_worship"];);out center;`;
                const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('API do mapa falhou.');
                    const data = await response.json();

                    if (data.elements.length === 0) {
                        UI.hideLoading();
                        UI.setupConfirmModal({ title: 'Nenhum Local Encontrado', message: 'Não foi possível identificar uma igreja ou local de culto neste ponto exato. Tente clicar um pouco mais perto do ícone.', actionText: 'OK', actionClass: 'bg-blue-600 hover:bg-blue-700', onConfirm: () => {}, showCancelButton: false });
                        return;
                    }

                    const element = data.elements[0];
                    const churchName = element.tags?.name || '';
                    const churchLat = element.center ? element.center.lat : element.lat;
                    const churchLng = element.center ? element.center.lon : element.lon;

                    const alreadyExists = allChurches.some(church => (Math.abs(church.coords[0] - churchLat) < 0.0001 && Math.abs(church.coords[1] - churchLng) < 0.0001));

                    if (alreadyExists) {
                        UI.hideLoading();
                        UI.setupConfirmModal({ title: 'Igreja já Cadastrada', message: `A igreja "${element.tags?.name || 'Neste local'}" já parece estar na sua base de dados.`, actionText: 'OK', actionClass: 'bg-blue-600 hover:bg-blue-700', onConfirm: () => {}, showCancelButton: false });
                        return;
                    }

                    const addr = await API.fetchAddressForCoords(churchLat, churchLng);
                    FormLogic.reset();
                    DOMElements.fields.name.value = churchName;
                    DOMElements.fields.lat.value = churchLat.toFixed(6);
                    DOMElements.fields.lng.value = churchLng.toFixed(6);
                    DOMElements.fields.bairro.value = addr.bairro;
                    DOMElements.fields.endereco.value = addr.endereco;
                    
                    if (!churchName) {
                        DOMElements.fields.name.placeholder = 'Digite o nome (não encontrado no mapa)';
                        DOMElements.fields.name.focus();
                    }
                    
                    UI.hideLoading();
                    UI.openPanel();
                    DOMElements.panelTitle.textContent = 'Confirmar Nova Igreja';

                } catch (e) {
                    console.error("Erro ao inspecionar o mapa:", e);
                    UI.hideLoading();
                    UI.setupConfirmModal({ title: 'Erro na Inspeção', message: 'Ocorreu um erro ao tentar buscar informações do mapa. Tente novamente.', actionText: 'OK', actionClass: 'bg-red-600 hover:bg-red-700', onConfirm: () => {}, showCancelButton: false });
                } finally {
                    isInspectMode = false;
                    DOMElements.inspectModeBtn.classList.remove('active');
                    document.body.classList.remove('inspect-mode-active');
                }
            },
            scanMapForChurches: async () => {
                UI.showProgressBar('Consultando base de dados do mapa...');

                // Query otimizada para ser mais estável, focando em tags específicas
                const query = `[out:json][timeout:120];
                    area[name="Blumenau"][boundary="administrative"][admin_level="8"]->.searchArea;
                    (
                        node["amenity"="place_of_worship"](area.searchArea);
                        way["amenity"="place_of_worship"](area.searchArea);
                        relation["amenity"="place_of_worship"](area.searchArea);
                        node["building"~"church|chapel|cathedral"](area.searchArea);
                        way["building"~"church|chapel|cathedral"](area.searchArea);
                        relation["building"~"church|chapel|cathedral"](area.searchArea);
                    );
                    out center;`;
                const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

                try {
                    const response = await fetch(url);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error("Erro da API Overpass:", errorText);
                        throw new Error(`A API do mapa retornou um erro: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    UI.updateProgressBar(0, `Processando dados encontrados...`);

                    const uniqueElements = [];
                    const existingCoords = new Set();
                    
                    for (const element of data.elements) {
                        const lat = element.center ? element.center.lat : element.lat;
                        const lon = element.center ? element.center.lon : element.lon;
                        const coordKey = `${lat.toFixed(5)},${lon.toFixed(5)}`;

                        if (!existingCoords.has(coordKey)) {
                            uniqueElements.push(element);
                            existingCoords.add(coordKey);
                        }
                    }

                    const newElements = uniqueElements.filter(element => {
                        if (!element.tags || !element.tags.name) {
                            return false;
                        }
                        const nameLower = element.tags.name.toLowerCase();
                        if (nameLower.includes('cemitério') || nameLower.includes('escola')) {
                            return false;
                        }
                        const lat = element.center ? element.center.lat : element.lat;
                        const lon = element.center ? element.center.lon : element.lon;
                        return !allChurches.some(church =>
                            (Math.abs(church.coords[0] - lat) < 0.0001 && Math.abs(church.coords[1] - lon) < 0.0001)
                        );
                    });


                    if (newElements.length === 0) {
                        UI.hideProgressBar();
                        UI.setupConfirmModal({
                            title: 'Escaneamento Concluído',
                            message: 'Nenhuma igreja nova foi encontrada em Blumenau. A base de dados parece estar atualizada.',
                            actionText: 'OK',
                            actionClass: 'bg-blue-600 hover:bg-blue-700',
                            onConfirm: () => {},
                            showCancelButton: false
                        });
                        return;
                    }

                    UI.updateProgressBar(0, `Encontrados ${newElements.length} locais. Buscando endereços...`);

                    const batch = writeBatch(db);
                    let newChurchesCount = 0;

                    for (let i = 0; i < newElements.length; i++) {
                        const element = newElements[i];
                        const percentage = ((i + 1) / newElements.length) * 100;
                        UI.updateProgressBar(percentage, `Buscando endereço ${i + 1} de ${newElements.length}`);
                        
                        const lat = element.center ? element.center.lat : element.lat;
                        const lon = element.center ? element.center.lon : element.lon;
                        const nome = element.tags.name;

                        const addr = await API.fetchAddressForCoords(lat, lon);
                        
                        newChurchesCount++;
                        const newDocRef = doc(igrejasCollectionRef);
                        batch.set(newDocRef, {
                            nome: nome,
                            coords: [lat, lon],
                            bairro: addr.bairro,
                            endereco: addr.endereco,
                            pastor: '',
                            horarios: [],
                            contato: '',
                            whatsapp: '',
                            redes_sociais: ''
                        });
                        
                        await new Promise(resolve => setTimeout(resolve, 1100)); // Pausa para não sobrecarregar API
                    }

                    if (newChurchesCount > 0) {
                        await batch.commit();
                        UI.setupConfirmModal({
                            title: 'Escaneamento Concluído',
                            message: `${newChurchesCount} nova(s) igreja(s) foram adicionada(s) com endereço.`,
                            actionText: 'OK',
                            actionClass: 'bg-blue-600 hover:bg-blue-700',
                            onConfirm: () => {},
                            showCancelButton: false
                        });
                    }
                } catch(e) {
                    UI.setupConfirmModal({
                        title: 'Erro no Escaneamento',
                        message: 'Não foi possível concluir o escaneamento. A API do mapa pode estar temporariamente indisponível ou a busca foi muito complexa. Por favor, tente novamente mais tarde.',
                        actionText: 'Entendi',
                        actionClass: 'bg-red-600 hover:bg-red-700',
                        onConfirm: () => {},
                        showCancelButton: false
                    });
                    console.error("Erro detalhado no escaneamento:", e);
                } finally {
                    UI.hideProgressBar();
                }
            }
        };
        
        // --- EVENT LISTENERS E INICIALIZAÇÃO ---

        function initializeEventListeners() {
            // Painel Lateral
            DOMElements.togglePanelBtn.addEventListener('click', () => {
                FormLogic.reset();
                UI.openPanel();
            });
            DOMElements.closePanelBtn.addEventListener('click', UI.closePanel);
            DOMElements.saveBtn.addEventListener('click', FormLogic.save);
            DOMElements.cancelEditBtn.addEventListener('click', FormLogic.reset);

            // Mapa
            map.on('click', (e) => {
                if (isInspectMode) {
                    Admin.findAndAddChurchFromMap(e.latlng.lat, e.latlng.lng);
                } else {
                    if (editingId) return; // Não muda o ponto ao editar
                    MapLogic.setLocationOnMap(e.latlng.lat, e.latlng.lng);
                    API.reverseGeocode(e.latlng.lat, e.latlng.lng);
                }
            });
            
            // Popups
            map.on('popupopen', (e) => {
                const popupNode = e.popup.getElement();
                popupNode.querySelector('.popup-edit-btn')?.addEventListener('click', (ev) => {
                    FormLogic.startEdit(ev.target.dataset.id);
                });
                popupNode.querySelector('.popup-delete-btn')?.addEventListener('click', (ev) => {
                    const { id, name } = ev.target.dataset;
                    Admin.confirmDelete(id, name);
                });
            });

            // CEP
            let cepTimeout;
            DOMElements.fields.cep.addEventListener('input', function() {
                clearTimeout(cepTimeout);
                const cep = this.value.replace(/\D/g, '');
                if (cep.length === 8) {
                    cepTimeout = setTimeout(() => API.fetchCEP(cep), 500);
                } else {
                    UI.showMessage(DOMElements.cepMessageArea, '');
                }
            });

            DOMElements.fields.numero.addEventListener('input', function() {
                const numero = this.value.trim();
                if (currentStreet) {
                    DOMElements.fields.endereco.value = numero ? `${currentStreet}, ${numero}` : currentStreet;
                }
            });

            // Importar Google Maps
            document.getElementById('import-gmaps-btn').addEventListener('click', () => {
                const url = DOMElements.gmapsUrlInput.value;
                const regex = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
                const match = url.match(regex);
                if (match && match[1] && match[2]) {
                    const lat = parseFloat(match[1]);
                    const lng = parseFloat(match[2]);
                    MapLogic.setLocationOnMap(lat, lng);
                    API.reverseGeocode(lat, lng);
                    UI.showMessage(DOMElements.importMessageArea, 'Coordenadas importadas com sucesso!');
                } else {
                    UI.showMessage(DOMElements.importMessageArea, 'URL inválida ou não contém coordenadas.', true);
                }
            });

            // Lista de Igrejas
            DOMElements.churchCounter.addEventListener('click', () => {
                const contentDiv = DOMElements.churchListContent;
                contentDiv.innerHTML = '';
                const grouped = allChurches.reduce((acc, church) => {
                    const bairro = church.bairro || 'Sem Bairro';
                    if (!acc[bairro]) acc[bairro] = [];
                    acc[bairro].push(church);
                    return acc;
                }, {});
                
                Object.keys(grouped).sort().forEach(bairro => {
                    contentDiv.insertAdjacentHTML('beforeend', `<h4 class="text-xl font-bold text-blue-800 mt-5 first:mt-0 mb-3 border-b-2 border-blue-200 pb-2">${bairro}</h4>`);
                    const list = document.createElement('ul');
                    list.className = 'space-y-2';
                    grouped[bairro].sort((a,b) => a.nome.localeCompare(b.nome)).forEach(church => {
                        const li = document.createElement('li');
                        li.className = 'p-3 rounded-lg hover:bg-gray-100 cursor-pointer text-gray-800';
                        li.textContent = church.nome;
                        li.onclick = () => {
                            const marker = allMarkers.find(m => m.churchId === church.id);
                            if (marker) {
                                map.setView(marker.getLatLng(), 18);
                                marker.openPopup();
                            }
                            UI.hideModal('church-list-modal');
                        };
                        list.appendChild(li);
                    });
                    contentDiv.appendChild(list);
                });
                
                UI.showModal('church-list-modal');
            });
            document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => UI.hideModal(btn.closest('.fixed').id)));
            
            // Funções Admin
            document.getElementById('clear-map-btn').addEventListener('click', Admin.confirmClearMap);
            document.getElementById('scan-map-btn').addEventListener('click', Admin.confirmScanMap);
            DOMElements.inspectModeBtn.addEventListener('click', () => {
                isInspectMode = !isInspectMode;
                DOMElements.inspectModeBtn.classList.toggle('active', isInspectMode);
                document.body.classList.toggle('inspect-mode-active', isInspectMode);
                if (isInspectMode) {
                    UI.setupConfirmModal({
                        title: 'Modo Inspeção Ativado',
                        message: 'Clique em um ícone de cruz no mapa para adicionar uma igreja não cadastrada.',
                        actionText: 'Entendi!',
                        actionClass: 'bg-blue-600 hover:bg-blue-700',
                        onConfirm: () => {},
                        showCancelButton: false
                    });
                }
            });

            // Pesquisa
            DOMElements.searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                DOMElements.clearSearchBtn.classList.toggle('hidden', query.length === 0);
                
                displayedChurches = allChurches.filter(c => 
                    c.nome.toLowerCase().includes(query) ||
                    (c.pastor && c.pastor.toLowerCase().includes(query)) ||
                    (c.bairro && c.bairro.toLowerCase().includes(query))
                );
                MapLogic.redrawAllMarkers();
            });

            DOMElements.clearSearchBtn.addEventListener('click', () => {
                DOMElements.searchInput.value = '';
                DOMElements.clearSearchBtn.classList.add('hidden');
                displayedChurches = [...allChurches];
                MapLogic.redrawAllMarkers();
            });

            // Geolocalização
            document.getElementById('user-location-btn').addEventListener('click', MapLogic.findUserLocation);
        }

        async function main() {
            UI.showLoading('Autenticando...');
            try {
                // Autenticação anônima do Firebase
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                UI.showLoading('Carregando dados das igrejas...');
                
                // Listener de dados do Firestore
                onSnapshot(igrejasCollectionRef, (snapshot) => {
                    allChurches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sincroniza a lista filtrada se não houver filtro ativo
                    if (DOMElements.searchInput.value.trim() === '') {
                        displayedChurches = [...allChurches];
                    }
                    MapLogic.redrawAllMarkers();
                    UI.hideLoading();
                }, (error) => {
                    console.error("Erro ao buscar dados: ", error);
                    DOMElements.churchCounter.innerHTML = `<strong class="text-red-500">ERRO AO CARREGAR DADOS</strong>`;
                    UI.hideLoading();
                });

            } catch (error) {
                console.error("Erro na autenticação:", error);
                DOMElements.churchCounter.innerHTML = `<strong class="text-red-500">FALHA NA AUTENTICAÇÃO</strong>`;
                UI.hideLoading();
            }
        }
        
        // --- PONTO DE ENTRADA ---
        document.addEventListener('DOMContentLoaded', () => {
            FormLogic.setupHorarios();
            initializeEventListeners();
            main();
        });
    </script>
</body>
</html>

