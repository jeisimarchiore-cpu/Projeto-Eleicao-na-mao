<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Igrejas de Blumenau</title>

    <!-- 1. Incluindo a biblioteca Leaflet.js (CSS e JS) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    
    <!-- Incluindo o plugin Leaflet.awesome-markers para ícones melhores -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
    
    <!-- Font Awesome para os ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


    <style>
        /* Estilos CSS */
        html, body { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100%; width: 100%; cursor: grab; }
        .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .leaflet-popup-content h3 { margin: 0 0 10px; color: #333; font-size: 1.1em; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .leaflet-popup-content p { margin: 5px 0; font-size: 0.9em; color: #555; }
        .leaflet-popup-content a { color: #007bff; text-decoration: none; }
        .popup-actions { margin-top: 10px; display: flex; gap: 5px; }
        .popup-btn { padding: 5px 10px; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .popup-edit-btn { background-color: #ffc107; color: #333; }
        .popup-delete-btn { background-color: #dc3545; }
        #side-panel { display: none; position: absolute; top: 10px; right: 50px; z-index: 1000; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); width: 320px; max-height: 90%; overflow-y: auto; }
        #side-panel.visible { display: block; }
        #side-panel h3 { margin-top: 0; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-group input, .form-group select { width: 95%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .input-group { display: flex; align-items: center; }
        .input-group input { flex-grow: 1; }
        .input-group button { margin-left: 5px; padding: 8px 12px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .schedule-day { display: flex; flex-direction: column; margin-bottom: 8px; }
        .schedule-day-label { font-weight: bold; display: flex; align-items: center; }
        .schedule-day-label input[type="checkbox"] { margin-right: 8px; width: auto; }
        .schedule-day-fields { padding-left: 26px; display: none; }
        .schedule-day-fields.active { display: block; }
        .schedule-day-fields input, .schedule-day-fields select { width: 95%; padding: 6px; font-size: 0.9em; margin-bottom: 5px; }
        .time-fields { display: flex; align-items: center; gap: 5px; }
        .time-fields select { width: auto; flex-grow: 1; }
        #save-church-btn { width: 100%; padding: 10px; color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; transition: background-color 0.3s; }
        #cancel-edit-btn { width: 100%; padding: 10px; margin-top: 5px; background-color: #6c757d; color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; }
        #message-area, #import-message-area, #cep-message-area { margin-top: 5px; font-size: 0.9em; color: #28a745; height: 1.2em; }
        #message-area.error, #import-message-area.error, #cep-message-area.error { color: #dc3545; }
        hr { border: none; border-top: 1px solid #eee; margin: 15px 0; }
        #bottom-left-controls { position: absolute; bottom: 20px; left: 20px; z-index: 999; display: flex; gap: 10px; align-items: center; }
        #church-counter { background: rgba(255, 255, 255, 0.9); padding: 8px 15px; border-radius: 8px; font-size: 1.1em; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); cursor: pointer; line-height: 1.4; }
        
        #add-church-toggle-btn { position: absolute; top: 10px; right: 10px; z-index: 999; width: 40px; height: 40px; font-size: 1.5em; background-color: white; border: none; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); cursor: pointer; }
        
        .filter-container { background: white; padding: 5px 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .filter-container label { font-weight: bold; margin-right: 5px; font-size: 0.9em; }
        .filter-container select { padding: 5px; border-radius: 3px; border: 1px solid #ccc; }

        .modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; position: relative; }
        .modal-content h2 { margin-top: 0;}
        .modal-close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;}
        #clear-map-btn, #scan-map-btn { border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em; }
        #clear-map-btn { background-color: #dc3545; color: white; }
        #scan-map-btn { background-color: #007bff; color: white; }
        #church-list-content h4 { margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #007bff; padding-bottom: 5px; color: #007bff; text-align: left; }
        #church-list-content ul { list-style-type: none; padding: 0; text-align: left; max-height: 60vh; overflow-y: auto;}
        #church-list-content li { padding: 8px; border-bottom: 1px solid #ddd; cursor: pointer; }
        #church-list-content li:hover { background-color: #f1f1f1; }
        #confirm-modal .modal-content { max-width: 400px; text-align: center;}
        .modal-buttons { margin-top: 20px; }
        .modal-buttons button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 0 10px; }
        #confirm-delete-btn { background-color: #dc3545; color: white; }
        #cancel-delete-btn { background-color: #6c757d; color: white; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="bottom-left-controls">
        <div id="church-counter">Carregando igrejas...</div>
        <div class="filter-container">
            <label for="bairro-filter-select">Bairro:</label>
            <select id="bairro-filter-select"></select>
        </div>
    </div>
    <button id="add-church-toggle-btn" title="Adicionar Nova Igreja">+</button>

    <!-- Modais -->
    <div id="church-list-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h2>Lista de Igrejas por Bairro</h2>
            <div id="church-list-content"></div>
            <div class="modal-footer">
                <div>
                    <select id="scan-bairro-select"></select>
                    <button id="scan-map-btn" title="Escanear bairro por novas igrejas"><i class="fa fa-search"></i> Escanear Bairro</button>
                </div>
                <button id="clear-map-btn" title="Apagar todos os dados do mapa"><i class="fa fa-trash-alt"></i> Limpar Mapa</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close-btn">&times;</span><h3>Confirmar Exclusão</h3><p id="confirm-message"></p><div class="modal-buttons"><button id="confirm-delete-btn">Sim, Excluir</button><button id="cancel-delete-btn">Cancelar</button></div></div></div>
    
    <!-- Painel Lateral -->
    <div id="side-panel">
        <h3 id="panel-title">Adicionar Nova Igreja</h3>
        <div class="form-group"><label for="gmaps-url">Importar do Google Maps</label><div class="input-group"><input type="url" id="gmaps-url" placeholder="Cole o link do Google Maps aqui"><button type="button" id="import-gmaps-btn" title="Importar dados do link"><i class="fa fa-download"></i></button></div><div id="import-message-area"></div></div>
        <hr>
        <p id="coords-info" style="font-size: 0.9em; color: #555; margin-bottom: 15px;">Clique no mapa ou use o CEP para localizar.</p>
        <form id="church-form"><div class="form-group"><label for="church-name">Nome da Igreja</label><input type="text" id="church-name" required></div><div class="form-group"><label for="church-pastor">Líder / Pastor / Padre</label><input type="text" id="church-pastor"></div><div class="form-group"><label for="church-cep">CEP</label><input type="text" id="church-cep" placeholder="Digite os 8 dígitos do CEP"><div id="cep-message-area"></div></div><div class="form-group"><label for="church-numero">Número</label><input type="text" id="church-numero"></div><div class="form-group"><label for="church-bairro">Bairro</label><input type="text" id="church-bairro"></div><div class="form-group"><label for="church-endereco">Endereço Completo</label><input type="text" id="church-endereco"></div><div class="form-group"><label>Horários e Atividades</label><div id="horarios-container"></div></div><div class="form-group"><label for="church-contato">Telefone Fixo</label><input type="text" id="church-contato"></div><div class="form-group"><label for="church-whatsapp">WhatsApp</label><input type="text" id="church-whatsapp" placeholder="(47) 9....-...."></div><div class="form-group"><label for="church-redes">Rede Social (URL)</label><input type="url" id="church-redes"></div><div class="form-group" style="display: none;"><label>Coordenadas</label><input type="text" id="church-coords-lat" placeholder="Latitude" readonly><input type="text" id="church-coords-lng" placeholder="Longitude" readonly></div><button type="button" id="save-church-btn">Adicionar Igreja</button><button type="button" id="cancel-edit-btn" style="display: none;">Cancelar Edição</button><div id="message-area"></div></form>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, setDoc, deleteDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDXmAZ-VW7Ti1_L5GPW0gNBkfGxMmxvypQ",
            authDomain: "controle-de-igrejas.firebaseapp.com",
            projectId: "controle-de-igrejas",
            storageBucket: "controle-de-igrejas.appspot.com",
            messagingSenderId: "457376397325",
            appId: "1:457376397325:web:aacc6cef3e91390314fd44",
            measurementId: "G-PENC7PPT4M"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);
        const igrejasCollection = collection(db, 'igrejas');

        const centroBlumenau = { lat: -26.9194, lng: -49.0661, zoom: 13 };
        const map = L.map('map').setView([centroBlumenau.lat, centroBlumenau.lng], centroBlumenau.zoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(map);
        const iconeIgreja = L.AwesomeMarkers.icon({ icon: 'church', markerColor: 'darkred', prefix: 'fa' });
        const iconeTemporario = L.AwesomeMarkers.icon({ icon: 'plus', markerColor: 'blue', prefix: 'fa' });
        const camadaIgrejas = L.layerGroup().addTo(map);
        const diasDaSemana = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
        
        const bairrosDeBlumenau = ["Água Verde", "Badenfurt", "Boa Vista", "Bom Retiro", "Centro", "Escola Agrícola", "Fidélis", "Fortaleza", "Fortaleza Alta", "Garcia", "Glória", "Itoupava Central", "Itoupava Norte", "Itoupava Seca", "Itoupavazinha", "Jardim Blumenau", "Nova Esperança", "Passo Manso", "Ponta Aguda", "Progresso", "Ribeirão Fresco", "Salto", "Salto do Norte", "Salto Weissbach", "Testo Salto", "Tribess", "Valparaíso", "Velha", "Velha Central", "Velha Grande", "Victor Konder", "Vila Formosa", "Vila Itoupava", "Vila Nova", "Vorstadt"];
        const bairroCoords = {
            "Água Verde": { lat: -26.923, lng: -49.112, zoom: 15 }, "Badenfurt": { lat: -26.858, lng: -49.141, zoom: 14 },
            "Boa Vista": { lat: -26.911, lng: -49.053, zoom: 15 }, "Bom Retiro": { lat: -26.906, lng: -49.043, zoom: 15 },
            "Centro": { lat: -26.918, lng: -49.066, zoom: 15 }, "Escola Agrícola": { lat: -26.911, lng: -49.091, zoom: 15 },
            "Fidélis": { lat: -26.828, lng: -49.122, zoom: 14 }, "Fortaleza": { lat: -26.87, lng: -49.11, zoom: 14 },
            "Fortaleza Alta": { lat: -26.877, lng: -49.124, zoom: 15 }, "Garcia": { lat: -26.938, lng: -49.07, zoom: 14 },
            "Glória": { lat: -26.947, lng: -49.088, zoom: 15 }, "Itoupava Central": { lat: -26.82, lng: -49.12, zoom: 13 },
            "Itoupava Norte": { lat: -26.883, lng: -49.083, zoom: 14 }, "Itoupava Seca": { lat: -26.907, lng: -49.078, zoom: 15 },
            "Itoupavazinha": { lat: -26.85, lng: -49.1, zoom: 14 }, "Jardim Blumenau": { lat: -26.915, lng: -49.06, zoom: 16 },
            "Nova Esperança": { lat: -26.89, lng: -49.13, zoom: 15 }, "Passo Manso": { lat: -26.936, lng: -49.125, zoom: 14 },
            "Ponta Aguda": { lat: -26.918, lng: -49.05, zoom: 14 }, "Progresso": { lat: -26.96, lng: -49.11, zoom: 14 },
            "Ribeirão Fresco": { lat: -26.928, lng: -49.06, zoom: 15 }, "Salto": { lat: -26.92, lng: -49.14, zoom: 15 },
            "Salto do Norte": { lat: -26.87, lng: -49.1, zoom: 14 }, "Salto Weissbach": { lat: -26.927, lng: -49.12, zoom: 15 },
            "Testo Salto": { lat: -26.84, lng: -49.16, zoom: 14 }, "Tribess": { lat: -26.89, lng: -49.11, zoom: 15 },
            "Valparaíso": { lat: -26.94, lng: -49.06, zoom: 15 }, "Velha": { lat: -26.92, lng: -49.1, zoom: 14 },
            "Velha Central": { lat: -26.925, lng: -49.105, zoom: 15 }, "Velha Grande": { lat: -26.93, lng: -49.115, zoom: 15 },
            "Victor Konder": { lat: -26.912, lng: -49.07, zoom: 16 }, "Vila Formosa": { lat: -26.945, lng: -49.07, zoom: 16 },
            "Vila Itoupava": { lat: -26.77, lng: -49.15, zoom: 13 }, "Vila Nova": { lat: -26.91, lng: -49.085, zoom: 15 },
            "Vorstadt": { lat: -26.92, lng: -49.05, zoom: 15 }
        };

        let igrejas = [];
        let marcadorTemporario = null;
        let idEmEdicao = null;
        let ruaDoCep = '';
        let markers = [];
        
        function updateChurchCount(filteredCount = null) { 
            const total = igrejas.length;
            let text = `<i class="fa fa-church"></i> Total: <strong>${total}</strong>`;
            if (filteredCount !== null && filteredCount !== total) {
                text = `<i class="fa fa-filter"></i> Mostrando <strong>${filteredCount}</strong> de <strong>${total}</strong>`;
            }
            document.getElementById('church-counter').innerHTML = text;
        }

        function showMessage(elementId, message, isError = false) { /* ... */ }
        function redesenharTodosOsMarcadores(bairroFiltrado = null) { /* ... */ }
        window.iniciarEdicao = (id) => { /* ... */ };
        window.confirmarExclusao = (id, nome) => { /* ... */ };
        function resetarPainel() { /* ... */ }
        function setLocationOnMap(lat, lng, zoomLevel = 18) { /* ... */ }
        async function reverseGeocode(lat, lon) { /* ... */ }
        
        map.on('click', function(e) { /* ... */ });
        document.getElementById('cancel-edit-btn').addEventListener('click', resetarPainel);
        document.getElementById('church-numero').addEventListener('input', function() { /* ... */ });
        document.getElementById('save-church-btn').addEventListener('click', async function() { /* ... */ });
        document.getElementById('church-cep').addEventListener('input', async function() { /* ... */ });
        document.getElementById('import-gmaps-btn').addEventListener('click', function() { /* ... */ });
        
        const modal = document.getElementById('church-list-modal');
        const closeModalBtn = modal.querySelector('.modal-close-btn');
        function showChurchListModal() { /* ... */ }
        document.getElementById('church-counter').addEventListener('click', showChurchListModal);
        closeModalBtn.onclick = () => { modal.style.display = 'none'; };
        
        window.onclick = (event) => { /* ... */ };
        const confirmModal = document.getElementById('confirm-modal');
        confirmModal.querySelector('.modal-close-btn').onclick = () => confirmModal.style.display = 'none';
        
        document.getElementById('clear-map-btn').addEventListener('click', () => { /* ... */ });
        async function clearAllData() { /* ... */ }

        const timeOptions = (() => { let opts = '<option value="">--:--</option>'; for (let h=0;h<24;h++) for(let m=0;m<60;m+=30) {const t=`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; opts+=`<option value="${t}">${t}</option>`;} return opts; })();
        const horariosContainer = document.getElementById('horarios-container');
        diasDaSemana.forEach(dia => { /* ... */ });

        document.getElementById('scan-map-btn').addEventListener('click', () => { /* ... */ });
        async function scanMapForChurches(bairroNome) { /* ... */ }
        
        function populateFilters() {
            const filterSelect = document.getElementById('bairro-filter-select');
            const scanSelect = document.getElementById('scan-bairro-select');
            let filterOptions = '<option value="">Todos os Bairros</option>';
            let scanOptions = '<option value="">Selecione um Bairro</option>';
            bairrosDeBlumenau.sort().forEach(bairro => {
                filterOptions += `<option value="${bairro}">${bairro}</option>`;
                scanOptions += `<option value="${bairro}">${bairro}</option>`;
            });
            filterSelect.innerHTML = filterOptions;
            scanSelect.innerHTML = scanOptions;
        }

        document.getElementById('bairro-filter-select').addEventListener('change', function() {
            const bairro = this.value;
            redesenharTodosOsMarcadores(bairro);
            if (bairro && bairroCoords[bairro]) {
                const { lat, lng, zoom } = bairroCoords[bairro];
                map.setView([lat, lng], zoom);
            } else {
                map.setView([centroBlumenau.lat, centroBlumenau.lng], centroBlumenau.zoom);
            }
        });
        
        document.getElementById('add-church-toggle-btn').addEventListener('click', () => {
            document.getElementById('side-panel').classList.toggle('visible');
        });

        async function main() {
            try {
                await signInAnonymously(auth);
                onSnapshot(igrejasCollection, (snapshot) => {
                    igrejas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const currentFilter = document.getElementById('bairro-filter-select').value;
                    redesenharTodosOsMarcadores(currentFilter);
                }, (error) => { console.error("Erro ao buscar dados: ", error); document.getElementById('church-counter').innerHTML = `<strong style="color: red;">ERRO:</strong> Verifique as regras do Firestore.`; });
            } catch (error) {
                console.error("Erro na autenticação: ", error);
                if (error.code === 'auth/configuration-not-found') { document.getElementById('church-counter').innerHTML = `<strong style="color: red;">AÇÃO NECESSÁRIA:</strong> Ative a Autenticação Anônima no seu projeto Firebase.`; } 
                else { document.getElementById('church-counter').textContent = 'Erro de conexão. Verifique a chave de API.'; }
            }
        }
        
        populateFilters();
        main();
        resetarPainel();
    </script>
</body>
</html>

