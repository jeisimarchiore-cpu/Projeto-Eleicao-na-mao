<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Igrejas de Blumenau</title>

    <!-- 1. Incluindo a biblioteca Leaflet.js (CSS e JS) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    
    <!-- Incluindo o plugin Leaflet.awesome-markers para ícones melhores -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
    
    <!-- Font Awesome para os ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


    <style>
        /* Estilos CSS (sem alterações) */
        html, body { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100%; width: 100%; cursor: grab; }
        .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .leaflet-popup-content h3 { margin: 0 0 10px; color: #333; font-size: 1.1em; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .leaflet-popup-content p { margin: 5px 0; font-size: 0.9em; color: #555; }
        .leaflet-popup-content a { color: #007bff; text-decoration: none; }
        .popup-actions { margin-top: 10px; display: flex; gap: 5px; }
        .popup-btn { padding: 5px 10px; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .popup-edit-btn { background-color: #ffc107; color: #333; }
        .popup-delete-btn { background-color: #dc3545; }
        #side-panel { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); width: 320px; max-height: 90%; overflow-y: auto; }
        #side-panel h3 { margin-top: 0; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-group input, .form-group select { width: 95%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .input-group { display: flex; align-items: center; }
        .input-group input { flex-grow: 1; }
        .input-group button { margin-left: 5px; padding: 8px 12px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .schedule-day { display: flex; flex-direction: column; margin-bottom: 8px; }
        .schedule-day-label { font-weight: bold; display: flex; align-items: center; }
        .schedule-day-label input[type="checkbox"] { margin-right: 8px; width: auto; }
        .schedule-day-fields { padding-left: 26px; display: none; }
        .schedule-day-fields.active { display: block; }
        .schedule-day-fields input, .schedule-day-fields select { width: 95%; padding: 6px; font-size: 0.9em; margin-bottom: 5px; }
        .time-fields { display: flex; align-items: center; gap: 5px; }
        .time-fields select { width: auto; flex-grow: 1; }
        #save-church-btn { width: 100%; padding: 10px; color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; transition: background-color 0.3s; }
        #cancel-edit-btn { width: 100%; padding: 10px; margin-top: 5px; background-color: #6c757d; color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; }
        #message-area, #import-message-area, #cep-message-area { margin-top: 5px; font-size: 0.9em; color: #28a745; height: 1.2em; }
        #message-area.error, #import-message-area.error, #cep-message-area.error { color: #dc3545; }
        hr { border: none; border-top: 1px solid #eee; margin: 15px 0; }
        #bottom-left-controls { position: absolute; bottom: 20px; left: 20px; z-index: 999; display: flex; gap: 10px; }
        #church-counter, #scan-button { background: rgba(255, 255, 255, 0.9); padding: 8px 15px; border-radius: 8px; font-size: 1.1em; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); cursor: pointer; line-height: 1.4; }
        #scan-button { background-color: #007bff; color: white; border: none; }
        .modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; position: relative; }
        .modal-content h2 { margin-top: 0;}
        .modal-close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        #church-list-content h4 { margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #007bff; padding-bottom: 5px; color: #007bff; text-align: left; }
        #church-list-content ul { list-style-type: none; padding: 0; text-align: left; max-height: 60vh; overflow-y: auto;}
        #church-list-content li { padding: 8px; border-bottom: 1px solid #ddd; cursor: pointer; }
        #church-list-content li:hover { background-color: #f1f1f1; }
        #confirm-modal .modal-content { max-width: 400px; text-align: center;}
        .modal-buttons { margin-top: 20px; }
        .modal-buttons button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 0 10px; }
        #confirm-delete-btn { background-color: #dc3545; color: white; }
        #cancel-delete-btn { background-color: #6c757d; color: white; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="bottom-left-controls">
        <div id="church-counter">Carregando igrejas...</div>
        <button id="scan-button" title="Escanear área por novas igrejas"><i class="fa fa-search"></i> Escanear Área</button>
    </div>

    <!-- Modais -->
    <div id="church-list-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close-btn">&times;</span><h2>Lista de Igrejas por Bairro</h2><div id="church-list-content"></div></div></div>
    <div id="confirm-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close-btn">&times;</span><h3>Confirmar Exclusão</h3><p id="confirm-message"></p><div class="modal-buttons"><button id="confirm-delete-btn">Sim, Excluir</button><button id="cancel-delete-btn">Cancelar</button></div></div></div>
    
    <!-- Painel Lateral -->
    <div id="side-panel">
        <h3 id="panel-title">Adicionar Nova Igreja</h3>
        <div class="form-group"><label for="gmaps-url">Importar do Google Maps</label><div class="input-group"><input type="url" id="gmaps-url" placeholder="Cole o link do Google Maps aqui"><button type="button" id="import-gmaps-btn" title="Importar dados do link"><i class="fa fa-download"></i></button></div><div id="import-message-area"></div></div>
        <hr>
        <p id="coords-info" style="font-size: 0.9em; color: #555; margin-bottom: 15px;">Clique no mapa ou use o CEP para localizar.</p>
        <form id="church-form"><div class="form-group"><label for="church-name">Nome da Igreja</label><input type="text" id="church-name" required></div><div class="form-group"><label for="church-pastor">Líder / Pastor / Padre</label><input type="text" id="church-pastor"></div><div class="form-group"><label for="church-cep">CEP</label><input type="text" id="church-cep" placeholder="Digite os 8 dígitos do CEP"><div id="cep-message-area"></div></div><div class="form-group"><label for="church-numero">Número</label><input type="text" id="church-numero"></div><div class="form-group"><label for="church-bairro">Bairro</label><input type="text" id="church-bairro"></div><div class="form-group"><label for="church-endereco">Endereço Completo</label><input type="text" id="church-endereco"></div><div class="form-group"><label>Horários e Atividades</label><div id="horarios-container"></div></div><div class="form-group"><label for="church-contato">Telefone Fixo</label><input type="text" id="church-contato"></div><div class="form-group"><label for="church-whatsapp">WhatsApp</label><input type="text" id="church-whatsapp" placeholder="(47) 9....-...."></div><div class="form-group"><label for="church-redes">Rede Social (URL)</label><input type="url" id="church-redes"></div><div class="form-group" style="display: none;"><label>Coordenadas</label><input type="text" id="church-coords-lat" placeholder="Latitude" readonly><input type="text" id="church-coords-lng" placeholder="Longitude" readonly></div><button type="button" id="save-church-btn">Adicionar Igreja</button><button type="button" id="cancel-edit-btn" style="display: none;">Cancelar Edição</button><div id="message-area"></div></form>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, setDoc, deleteDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDXmAZ-VW7Ti1_L5GPW0gNBkfGxMmxvypQ",
            authDomain: "controle-de-igrejas.firebaseapp.com",
            projectId: "controle-de-igrejas",
            storageBucket: "controle-de-igrejas.appspot.com",
            messagingSenderId: "457376397325",
            appId: "1:457376397325:web:aacc6cef3e91390314fd44",
            measurementId: "G-PENC7PPT4M"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const igrejasCollection = collection(db, 'igrejas');

        const centroBlumenau = [-26.9194, -49.0661];
        const zoomInicial = 13;
        const map = L.map('map').setView(centroBlumenau, zoomInicial);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(map);
        const iconeIgreja = L.AwesomeMarkers.icon({ icon: 'church', markerColor: 'darkred', prefix: 'fa' });
        const iconeTemporario = L.AwesomeMarkers.icon({ icon: 'plus', markerColor: 'blue', prefix: 'fa' });
        const camadaIgrejas = L.layerGroup().addTo(map);
        const diasDaSemana = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
        let igrejas = [];
        let marcadorTemporario = null;
        let idEmEdicao = null;
        let ruaDoCep = '';
        let markers = [];

        function updateChurchCount() { document.getElementById('church-counter').innerHTML = `<i class="fa fa-church"></i> Total de Igrejas: <strong>${igrejas.length}</strong>`; }
        function showMessage(elementId, message, isError = false) { const el = document.getElementById(elementId); el.textContent = message; el.classList.toggle('error', isError); }

        function redesenharTodosOsMarcadores() {
            camadaIgrejas.clearLayers();
            markers = [];
            igrejas.forEach((igreja) => {
                const marcador = L.marker(igreja.coords, { icon: iconeIgreja }).addTo(camadaIgrejas);
                let conteudoPopup = `<h3>${igreja.nome}</h3>`;
                if (igreja.pastor) conteudoPopup += `<p><strong>Líder:</strong> ${igreja.pastor}</p>`;
                conteudoPopup += `<p><strong>Endereço:</strong> ${igreja.endereco || 'Não informado'}</p>`;
                if (igreja.horarios && igreja.horarios.length > 0) { 
                    let horariosFormatados = "<strong>Horários:</strong><br>";
                    diasDaSemana.forEach(dia => {
                        const atividadesDoDia = igreja.horarios.filter(h => h.dia === dia);
                        if (atividadesDoDia.length > 0) {
                            horariosFormatados += `&bull; ${dia}: `;
                            horariosFormatados += atividadesDoDia.map(a => { let timeStr = a.horaInicio; if (a.horaFim) timeStr += ` - ${a.horaFim}`; return `${timeStr} - ${a.desc}`; }).join(', ');
                            horariosFormatados += `<br>`;
                        }
                    });
                    conteudoPopup += `<p>${horariosFormatados}</p>`;
                 }
                if (igreja.contato) conteudoPopup += `<p><strong>Telefone:</strong> ${igreja.contato}</p>`;
                if (igreja.whatsapp) conteudoPopup += `<p><strong>WhatsApp:</strong> ${igreja.whatsapp}</p>`;
                if (igreja.redes_sociais) conteudoPopup += `<p><a href="${igreja.redes_sociais}" target="_blank">Visitar Rede Social</a></p>`;
                conteudoPopup += `<div class="popup-actions"><button class="popup-btn popup-edit-btn" onclick="window.iniciarEdicao('${igreja.id}')">Editar</button><button class="popup-btn popup-delete-btn" onclick="window.confirmarExclusao('${igreja.id}', '${igreja.nome.replace(/'/g, "\\'")}')">Excluir</button></div>`;
                marcador.bindPopup(conteudoPopup);
                marcador.churchId = igreja.id;
                markers.push(marcador);
            });
            updateChurchCount();
        }

        window.iniciarEdicao = (id) => {
            const igreja = igrejas.find(i => i.id === id);
            if (!igreja) return;
            idEmEdicao = id;
            document.getElementById('church-name').value = igreja.nome || '';
            document.getElementById('church-pastor').value = igreja.pastor || '';
            document.getElementById('church-bairro').value = igreja.bairro || '';
            document.getElementById('church-endereco').value = igreja.endereco || '';
            document.getElementById('church-contato').value = igreja.contato || '';
            document.getElementById('church-whatsapp').value = igreja.whatsapp || '';
            document.getElementById('church-redes').value = igreja.redes_sociais || '';
            document.getElementById('church-coords-lat').value = igreja.coords[0];
            document.getElementById('church-coords-lng').value = igreja.coords[1];
            diasDaSemana.forEach(dia => {
                const diaId = dia.toLowerCase();
                const checkbox = document.getElementById(`check-${diaId}`);
                const fieldsDiv = document.getElementById(`fields-${diaId}`);
                const horaInicioSelect = document.getElementById(`hora-inicio-${diaId}`);
                const horaFimSelect = document.getElementById(`hora-fim-${diaId}`);
                const descInput = document.getElementById(`desc-${diaId}`);
                const atividade = igreja.horarios ? igreja.horarios.find(h => h.dia === dia) : null;
                if (atividade) {
                    checkbox.checked = true;
                    fieldsDiv.classList.add('active');
                    horaInicioSelect.value = atividade.horaInicio || '';
                    horaFimSelect.value = atividade.horaFim || '';
                    descInput.value = atividade.desc || '';
                } else {
                    checkbox.checked = false;
                    fieldsDiv.classList.remove('active');
                    horaInicioSelect.value = '';
                    horaFimSelect.value = '';
                    descInput.value = '';
                }
            });
            document.getElementById('panel-title').textContent = 'Editar Igreja';
            document.getElementById('save-church-btn').textContent = 'Salvar Alterações';
            document.getElementById('save-church-btn').style.backgroundColor = '#ffc107';
            document.getElementById('cancel-edit-btn').style.display = 'block';
            map.closePopup();
        };

        window.confirmarExclusao = (id, nome) => {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-message').textContent = `Tem certeza que deseja excluir a igreja "${nome}"?`;
            modal.style.display = 'block';
            document.getElementById('confirm-delete-btn').onclick = async () => {
                try { await deleteDoc(doc(db, 'igrejas', id)); } 
                catch (error) { console.error("Erro ao excluir: ", error); } 
                finally { modal.style.display = 'none'; }
            };
            document.getElementById('cancel-delete-btn').onclick = () => { modal.style.display = 'none'; };
            modal.querySelector('.modal-close-btn').onclick = () => { modal.style.display = 'none'; };
        };

        function resetarPainel() {
            idEmEdicao = null;
            ruaDoCep = '';
            document.getElementById('church-form').reset();
            document.getElementById('gmaps-url').value = '';
            diasDaSemana.forEach(dia => { const diaId = dia.toLowerCase(); document.getElementById(`check-${diaId}`).checked = false; document.getElementById(`fields-${diaId}`).classList.remove('active'); });
            if (marcadorTemporario) { map.removeLayer(marcadorTemporario); marcadorTemporario = null; }
            document.getElementById('coords-info').textContent = 'Clique no mapa ou use o CEP para localizar.';
            showMessage('message-area', '');
            document.getElementById('panel-title').textContent = 'Adicionar Nova Igreja';
            document.getElementById('save-church-btn').textContent = 'Adicionar Igreja';
            document.getElementById('save-church-btn').style.backgroundColor = '#28a745';
            document.getElementById('cancel-edit-btn').style.display = 'none';
        }

        function setLocationOnMap(lat, lng, zoomLevel = 18) {
            document.getElementById('church-coords-lat').value = lat.toFixed(6);
            document.getElementById('church-coords-lng').value = lng.toFixed(6);
            if (marcadorTemporario) map.removeLayer(marcadorTemporario);
            const latLng = [lat, lng];
            marcadorTemporario = L.marker(latLng, { icon: iconeTemporario }).addTo(map);
            map.setView(latLng, zoomLevel);
            document.getElementById('coords-info').textContent = 'Localização selecionada no mapa!';
        }
        
        async function reverseGeocode(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data && data.address) {
                    const addr = data.address;
                    const rua = addr.road || '';
                    const numero = addr.house_number || '';
                    const bairro = addr.suburb || addr.city_district || '';
                    return {
                        endereco: numero ? `${rua}, ${numero}` : rua,
                        bairro: bairro
                    };
                }
            } catch (error) { console.error("Erro no reverse geocode:", error); }
            return { endereco: '', bairro: '' };
        }

        map.on('click', function(e) { if (idEmEdicao !== null) return; setLocationOnMap(e.latlng.lat, e.latlng.lng); });
        document.getElementById('cancel-edit-btn').addEventListener('click', resetarPainel);
        document.getElementById('church-numero').addEventListener('input', function() { const numero = this.value.trim(); if (ruaDoCep) { document.getElementById('church-endereco').value = numero ? `${ruaDoCep}, ${numero}` : ruaDoCep; } });

        document.getElementById('save-church-btn').addEventListener('click', async function() {
            const lat = document.getElementById('church-coords-lat').value;
            const lng = document.getElementById('church-coords-lng').value;
            if (!document.getElementById('church-name').value || !lat || !lng) { showMessage('message-area', 'Preencha o nome e selecione uma localização.', true); return; }
            const horarios = [];
            diasDaSemana.forEach(dia => { const diaId = dia.toLowerCase(); if (document.getElementById(`check-${diaId}`).checked) { horarios.push({ dia: dia, horaInicio: document.getElementById(`hora-inicio-${diaId}`).value, horaFim: document.getElementById(`hora-fim-${diaId}`).value, desc: document.getElementById(`desc-${diaId}`).value }); } });
            const dadosIgreja = {
                nome: document.getElementById('church-name').value,
                pastor: document.getElementById('church-pastor').value,
                bairro: document.getElementById('church-bairro').value,
                endereco: document.getElementById('church-endereco').value,
                horarios: horarios,
                contato: document.getElementById('church-contato').value,
                whatsapp: document.getElementById('church-whatsapp').value,
                redes_sociais: document.getElementById('church-redes').value,
                coords: [parseFloat(lat), parseFloat(lng)]
            };
            this.textContent = 'Salvando...'; this.disabled = true;
            try {
                if (idEmEdicao) { await setDoc(doc(db, 'igrejas', idEmEdicao), dadosIgreja); } 
                else { await addDoc(igrejasCollection, dadosIgreja); }
                resetarPainel();
            } catch (error) { console.error("Erro ao salvar: ", error); showMessage('message-area', 'Erro ao salvar. Tente novamente.', true); } 
            finally { this.disabled = false; }
        });

        document.getElementById('church-cep').addEventListener('input', async function() {
            const cep = this.value.replace(/\D/g, '');
            if (cep.length === 8) {
                showMessage('cep-message-area', 'Buscando CEP...');
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();
                    if (data.erro) { showMessage('cep-message-area', 'CEP não encontrado.', true); ruaDoCep = ''; }
                    else {
                        ruaDoCep = data.logradouro || '';
                        document.getElementById('church-endereco').value = ruaDoCep;
                        document.getElementById('church-bairro').value = data.bairro || '';
                        document.getElementById('church-numero').value = '';
                        document.getElementById('church-numero').focus();
                        showMessage('cep-message-area', 'CEP encontrado!');
                    }
                } catch (error) { showMessage('cep-message-area', 'Erro ao buscar o CEP.', true); ruaDoCep = ''; }
            } else { showMessage('cep-message-area', ''); }
        });
        
        document.getElementById('import-gmaps-btn').addEventListener('click', function() { /* ... */ });
        
        const modal = document.getElementById('church-list-modal');
        const closeModalBtn = modal.querySelector('.modal-close-btn');
        function showChurchListModal() {
            const contentDiv = document.getElementById('church-list-content');
            contentDiv.innerHTML = '';
            const groupedByBairro = igrejas.reduce((acc, igreja) => { const bairro = igreja.bairro || 'Sem Bairro'; if (!acc[bairro]) acc[bairro] = []; acc[bairro].push(igreja); return acc; }, {});
            const bairros = Object.keys(groupedByBairro).sort();
            bairros.forEach(bairro => {
                const header = document.createElement('h4'); header.textContent = bairro; contentDiv.appendChild(header);
                const list = document.createElement('ul');
                groupedByBairro[bairro].sort((a,b) => a.nome.localeCompare(b.nome)).forEach(igreja => {
                    const listItem = document.createElement('li'); listItem.textContent = igreja.nome;
                    listItem.onclick = () => { const marker = markers.find(m => m.churchId == igreja.id); if (marker) { map.setView(marker.getLatLng(), 18); marker.openPopup(); } modal.style.display = 'none'; };
                    list.appendChild(listItem);
                });
                contentDiv.appendChild(list);
            });
            modal.style.display = 'block';
        }
        document.getElementById('church-counter').addEventListener('click', showChurchListModal);
        closeModalBtn.onclick = () => { modal.style.display = 'none'; };
        
        window.onclick = (event) => { 
            const listModal = document.getElementById('church-list-modal');
            const confirmModalEl = document.getElementById('confirm-modal');
            if (event.target == listModal) listModal.style.display = 'none';
            if (event.target == confirmModalEl) confirmModalEl.style.display = 'none';
        };
        const confirmModal = document.getElementById('confirm-modal');
        confirmModal.querySelector('.modal-close-btn').onclick = () => confirmModal.style.display = 'none';

        const timeOptions = (() => { let opts = '<option value="">--:--</option>'; for (let h=0;h<24;h++) for(let m=0;m<60;m+=30) {const t=`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; opts+=`<option value="${t}">${t}</option>`;} return opts; })();
        const horariosContainer = document.getElementById('horarios-container');
        diasDaSemana.forEach(dia => {
            const diaId = dia.toLowerCase();
            const dayDiv = document.createElement('div'); dayDiv.className = 'schedule-day';
            dayDiv.innerHTML = `<label class="schedule-day-label"><input type="checkbox" id="check-${diaId}"> ${dia}</label><div class="schedule-day-fields" id="fields-${diaId}"><input type="text" id="desc-${diaId}" placeholder="Descrição da Atividade"><div class="time-fields"><select id="hora-inicio-${diaId}">${timeOptions}</select><span>até</span><select id="hora-fim-${diaId}">${timeOptions}</select></div></div>`;
            horariosContainer.appendChild(dayDiv);
            const checkbox = dayDiv.querySelector(`#check-${diaId}`);
            const fieldsDiv = dayDiv.querySelector(`#fields-${diaId}`);
            checkbox.addEventListener('change', () => { fieldsDiv.classList.toggle('active', checkbox.checked); if(checkbox.checked) { fieldsDiv.querySelector(`#desc-${diaId}`).focus(); }});
        });

        document.getElementById('scan-button').addEventListener('click', async function() {
            const bounds = map.getBounds();
            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            const query = `[out:json][timeout:25];
            area[name="Blumenau"][boundary="administrative"][admin_level="8"]->.searchArea;
            (
                node["amenity"="place_of_worship"](area.searchArea)(${bbox});
                way["amenity"="place_of_worship"](area.searchArea)(${bbox});
                node["building"~"church|chapel|cathedral"](area.searchArea)(${bbox});
                way["building"~"church|chapel|cathedral"](area.searchArea)(${bbox});
            );
            out center;`;
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
            
            const btn = this;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Escaneando...';
            btn.disabled = true;

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                let newChurchesCount = 0;
                let updatedChurchesCount = 0;
                const batch = writeBatch(db);
                const promises = [];

                for (const element of data.elements) {
                    const lat = element.center ? element.center.lat : element.lat;
                    const lon = element.center ? element.center.lon : element.lon;
                    const nome = element.tags.name || "Igreja sem nome";
                    const coords = [lat, lon];
                    
                    const existingChurch = igrejas.find(igreja => 
                        (igreja.nome.trim().toLowerCase() === nome.trim().toLowerCase()) ||
                        (Math.abs(igreja.coords[0] - coords[0]) < 0.0001 && Math.abs(igreja.coords[1] - coords[1]) < 0.0001)
                    );

                    if (existingChurch) {
                        if (!existingChurch.endereco || existingChurch.endereco.trim() === '') {
                             promises.push(reverseGeocode(lat, lon).then(addr => {
                                if (addr.endereco) {
                                    updatedChurchesCount++;
                                    const churchRef = doc(db, 'igrejas', existingChurch.id);
                                    batch.update(churchRef, { endereco: addr.endereco, bairro: addr.bairro });
                                }
                            }));
                        }
                    } else {
                        newChurchesCount++;
                        promises.push(reverseGeocode(lat, lon).then(addr => {
                            const novaIgreja = {
                                nome: nome, coords: coords, bairro: addr.bairro || '', endereco: addr.endereco || '',
                                pastor: '', horarios: [], contato: '', whatsapp: '', redes_sociais: ''
                            };
                            const newDocRef = doc(igrejasCollection);
                            batch.set(newDocRef, novaIgreja);
                        }));
                    }
                }
                
                await Promise.all(promises);

                if (newChurchesCount > 0 || updatedChurchesCount > 0) {
                    await batch.commit();
                    let alertMessage = "Escaneamento concluído!\n";
                    if (newChurchesCount > 0) alertMessage += `${newChurchesCount} nova(s) igreja(s) foram adicionada(s).\n`;
                    if (updatedChurchesCount > 0) alertMessage += `${updatedChurchesCount} igreja(s) existente(s) foram atualizada(s) com o endereço.`;
                    alert(alertMessage);
                } else {
                    alert("Nenhuma igreja nova ou para atualizar foi encontrada na área visível do mapa.");
                }

            } catch (error) {
                console.error("Erro ao escanear:", error);
                alert("Ocorreu um erro ao escanear a área. Tente novamente.");
            } finally {
                btn.innerHTML = '<i class="fa fa-search"></i> Escanear Área';
                btn.disabled = false;
            }
        });
        
        async function main() {
            try {
                await signInAnonymously(auth);
                onSnapshot(igrejasCollection, (snapshot) => {
                    igrejas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    redesenharTodosOsMarcadores();
                }, (error) => { console.error("Erro ao buscar dados: ", error); document.getElementById('church-counter').innerHTML = `<strong style="color: red;">ERRO:</strong> Verifique as regras do Firestore.`; });
            } catch (error) {
                console.error("Erro na autenticação: ", error);
                if (error.code === 'auth/configuration-not-found') { document.getElementById('church-counter').innerHTML = `<strong style="color: red;">AÇÃO NECESSÁRIA:</strong> Ative a Autenticação Anônima no seu projeto Firebase.`; } 
                else { document.getElementById('church-counter').textContent = 'Erro de conexão. Verifique a chave de API.'; }
            }
        }
        
        main();
        resetarPainel();
    </script>
</body>
</html>

