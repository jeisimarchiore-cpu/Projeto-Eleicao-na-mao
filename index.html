<!DOCTYPE html>
<html lang="pt-br" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Colaborativo de Igrejas - Blumenau</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet.js (CSS e JS) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet.awesome-markers (Ícones) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
    
    <!-- Font Awesome (Ícones) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Estilos personalizados para complementar o Tailwind e o Leaflet */
        .leaflet-popup-content-wrapper {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
        }
        .leaflet-popup-content h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1f2937;
        }
        .leaflet-popup-content p {
            margin: 4px 0;
            font-size: 0.9rem;
            color: #4b5563;
        }
        .leaflet-popup-content strong {
            color: #374151;
        }
        #map-container {
             cursor: grab;
        }
        .leaflet-grabbing #map-container {
            cursor: grabbing;
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .schedule-day-fields { display: none; }
        .schedule-day-fields.active { display: block; }

        /* Animação para o painel lateral */
        #side-panel {
            transition: transform 0.3s ease-in-out;
        }
        #side-panel.closed {
            transform: translateX(100%);
        }
    </style>
</head>
<body class="h-full bg-gray-100 antialiased overflow-hidden">

    <div id="app-container" class="relative h-full w-full">
        <!-- O Contêiner do Mapa -->
        <div id="map-container" class="h-full w-full"></div>

        <!-- Overlays do Mapa (Controles, Pesquisa, etc.) -->
        <div class="absolute top-0 left-0 p-2 md:p-4 z-[999] w-full md:w-auto">
            <div class="bg-white/90 backdrop-blur-sm p-2 rounded-lg shadow-lg flex items-center space-x-2 w-full md:max-w-md">
                <i class="fa fa-search text-gray-400 px-2"></i>
                <input type="text" id="search-input" placeholder="Pesquisar por nome, líder ou bairro..." class="w-full bg-transparent focus:outline-none text-gray-700">
                <button id="clear-search-btn" class="hidden text-gray-500 hover:text-gray-800 pr-2">
                    <i class="fa fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Controles do Mapa (à direita) -->
        <div class="absolute top-4 right-4 z-[999] flex flex-col space-y-2">
             <button id="toggle-panel-btn" class="bg-white/90 backdrop-blur-sm w-10 h-10 rounded-lg shadow-lg flex items-center justify-center text-gray-700 hover:bg-gray-200 transition" title="Adicionar / Editar Igreja">
                <i class="fa fa-plus"></i>
            </button>
        </div>

        <div class="absolute bottom-10 right-4 z-[999] flex flex-col space-y-2">
            <button id="user-location-btn" class="bg-white/90 backdrop-blur-sm w-10 h-10 rounded-lg shadow-lg flex items-center justify-center text-blue-600 hover:bg-gray-200 transition" title="Minha Localização">
                <i class="fa fa-location-crosshairs"></i>
            </button>
        </div>
        
        <!-- Contador de Igrejas (à esquerda, inferior) -->
        <div id="church-counter" class="absolute bottom-4 left-4 z-[999] bg-white/90 backdrop-blur-sm py-2 px-4 rounded-lg shadow-lg cursor-pointer hover:bg-gray-50 transition">
            <span class="text-gray-800 font-semibold">Carregando igrejas...</span>
        </div>

        <!-- Painel Lateral para Adicionar/Editar -->
        <div id="side-panel" class="absolute top-0 right-0 h-full w-full max-w-md bg-white shadow-2xl z-[1000] p-6 flex flex-col closed">
            <div class="flex-shrink-0 flex justify-between items-center mb-4 border-b pb-4">
                <h3 id="panel-title" class="text-xl font-bold text-gray-800">Adicionar Nova Igreja</h3>
                <button id="close-panel-btn" class="text-gray-500 hover:text-gray-800">
                    <i class="fa fa-times fa-lg"></i>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scrollbar pr-2">
                <form id="church-form" class="space-y-4">
                    <!-- Importar do Google Maps -->
                    <div>
                        <label for="gmaps-url" class="block text-sm font-medium text-gray-700">Importar do Google Maps</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <input type="url" id="gmaps-url" placeholder="Cole o link do Google Maps aqui" class="flex-1 block w-full rounded-none rounded-l-md border-gray-300 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <button type="button" id="import-gmaps-btn" title="Importar dados do link" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 hover:bg-gray-100">
                                <i class="fa fa-download"></i>
                            </button>
                        </div>
                        <div id="import-message-area" class="mt-1 text-xs h-4"></div>
                    </div>

                    <div class="text-center text-gray-500">ou</div>

                    <p id="coords-info" class="text-sm text-gray-600 bg-gray-100 p-3 rounded-md text-center"><i class="fa fa-map-pin mr-2"></i>Clique no mapa ou use o CEP para localizar.</p>
                    
                    <!-- Campos do Formulário -->
                    <input type="hidden" id="church-coords-lat">
                    <input type="hidden" id="church-coords-lng">
                    
                    <div><label for="church-name" class="block text-sm font-medium text-gray-700">Nome da Igreja*</label><input type="text" id="church-name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                    <div><label for="church-pastor" class="block text-sm font-medium text-gray-700">Líder / Pastor / Padre</label><input type="text" id="church-pastor" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="church-cep" class="block text-sm font-medium text-gray-700">CEP</label><input type="text" id="church-cep" placeholder="Apenas números" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"><div id="cep-message-area" class="mt-1 text-xs h-4"></div></div>
                        <div><label for="church-numero" class="block text-sm font-medium text-gray-700">Número</label><input type="text" id="church-numero" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                    </div>
                     <div><label for="church-bairro" class="block text-sm font-medium text-gray-700">Bairro</label><input type="text" id="church-bairro" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm sm:text-sm" readonly></div>
                    <div><label for="church-endereco" class="block text-sm font-medium text-gray-700">Endereço Completo</label><input type="text" id="church-endereco" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm sm:text-sm" readonly></div>

                    <!-- Horários -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Horários e Atividades</label>
                        <div id="horarios-container" class="space-y-2"></div>
                    </div>

                    <div><label for="church-contato" class="block text-sm font-medium text-gray-700">Telefone Fixo</label><input type="tel" id="church-contato" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                    <div><label for="church-whatsapp" class="block text-sm font-medium text-gray-700">WhatsApp</label><input type="tel" id="church-whatsapp" placeholder="(47) 9XXXX-XXXX" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                    <div><label for="church-redes" class="block text-sm font-medium text-gray-700">Rede Social (URL)</label><input type="url" id="church-redes" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                </form>
            </div>
            <div class="flex-shrink-0 pt-6 border-t mt-4 space-y-2">
                 <div id="message-area" class="text-sm text-center h-5"></div>
                 <button type="button" id="save-church-btn" class="w-full bg-blue-600 text-white py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">Adicionar Igreja</button>
                 <button type="button" id="cancel-edit-btn" style="display: none;" class="w-full bg-gray-600 text-white py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition">Cancelar Edição</button>
            </div>
        </div>
    </div>

    <!-- Modal: Lista de Igrejas -->
    <div id="church-list-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 z-[1001] hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-lg font-bold text-gray-800">Lista de Igrejas por Bairro</h2>
                <button class="modal-close-btn text-gray-500 hover:text-gray-800"><i class="fa fa-times fa-lg"></i></button>
            </div>
            <div id="church-list-content" class="p-6 overflow-y-auto custom-scrollbar flex-grow"></div>
            <div class="flex justify-between items-center p-4 border-t bg-gray-50 rounded-b-lg">
                <span class="text-sm text-gray-600">Funções Administrativas</span>
                <div>
                     <button id="scan-map-btn" class="bg-blue-600 text-white text-sm font-medium py-2 px-4 rounded-md shadow-sm hover:bg-blue-700 transition" title="Escanear mapa por novas igrejas"><i class="fa fa-search mr-2"></i>Escanear Mapa</button>
                    <button id="clear-map-btn" class="bg-red-600 text-white text-sm font-medium py-2 px-4 rounded-md shadow-sm hover:bg-red-700 transition ml-2" title="Apagar todos os dados do mapa"><i class="fa fa-trash-alt mr-2"></i>Limpar Mapa</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Confirmação Genérica (para Excluir, Limpar, Escanear) -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 z-[1002] hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4 p-6 text-center">
            <h3 id="confirm-title" class="text-lg font-bold text-gray-900"></h3>
            <p id="confirm-message" class="mt-2 text-sm text-gray-600"></p>
            <div id="password-field-container" class="mt-4 hidden">
                <label for="admin-password" class="block text-sm font-medium text-gray-700">Senha de Administrador</label>
                <input type="password" id="admin-password" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <p id="password-error" class="text-red-500 text-xs mt-1 h-4"></p>
            </div>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="confirm-action-btn" class="px-6 py-2 rounded-md text-white font-semibold"></button>
                <button id="cancel-action-btn" class="px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md hover:bg-gray-300">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/50 backdrop-blur-sm z-[2000] flex flex-col items-center justify-center">
        <i class="fa fa-church fa-spin text-4xl text-blue-600"></i>
        <p class="mt-4 text-gray-700 font-semibold">Carregando mapa...</p>
    </div>


    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, setDoc, deleteDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURAÇÃO E INICIALIZAÇÃO ---
        
        const ADMIN_PASSWORD = "2308"; // Senha para funções perigosas (somente para demonstração)
        
        // Configuração do Firebase (substituída em ambiente de produção)
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" }; // Fallback
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-map-app';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const igrejasCollectionRef = collection(db, `artifacts/${appId}/public/data/igrejas`);

        // Configurações do Mapa
        const MAP_CENTER = [-26.9194, -49.0661];
        const INITIAL_ZOOM = 13;
        const map = L.map('map-container', { zoomControl: false }).setView(MAP_CENTER, INITIAL_ZOOM);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
            maxZoom: 19, 
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>' 
        }).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        const churchIcon = L.AwesomeMarkers.icon({ icon: 'church', markerColor: 'darkred', prefix: 'fa' });
        const tempIcon = L.AwesomeMarkers.icon({ icon: 'plus', markerColor: 'blue', prefix: 'fa' });
        const churchLayer = L.layerGroup().addTo(map);

        // --- ESTADO DA APLICAÇÃO ---
        
        let allChurches = [];
        let displayedChurches = [];
        let allMarkers = [];
        let tempMarker = null;
        let editingId = null;
        let currentStreet = '';

        const DIAS_SEMANA = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];

        // --- SELETORES DE DOM ---
        
        const DOMElements = {
            loadingOverlay: document.getElementById('loading-overlay'),
            sidePanel: document.getElementById('side-panel'),
            togglePanelBtn: document.getElementById('toggle-panel-btn'),
            closePanelBtn: document.getElementById('close-panel-btn'),
            form: document.getElementById('church-form'),
            panelTitle: document.getElementById('panel-title'),
            saveBtn: document.getElementById('save-church-btn'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            coordsInfo: document.getElementById('coords-info'),
            messageArea: document.getElementById('message-area'),
            importMessageArea: document.getElementById('import-message-area'),
            cepMessageArea: document.getElementById('cep-message-area'),
            churchListModal: document.getElementById('church-list-modal'),
            churchListContent: document.getElementById('church-list-content'),
            churchCounter: document.getElementById('church-counter'),
            searchInput: document.getElementById('search-input'),
            clearSearchBtn: document.getElementById('clear-search-btn'),
            confirmModal: document.getElementById('confirm-modal'),
            gmapsUrlInput: document.getElementById('gmaps-url'),
            horariosContainer: document.getElementById('horarios-container'),
            fields: {
                lat: document.getElementById('church-coords-lat'),
                lng: document.getElementById('church-coords-lng'),
                name: document.getElementById('church-name'),
                pastor: document.getElementById('church-pastor'),
                cep: document.getElementById('church-cep'),
                numero: document.getElementById('church-numero'),
                bairro: document.getElementById('church-bairro'),
                endereco: document.getElementById('church-endereco'),
                contato: document.getElementById('church-contato'),
                whatsapp: document.getElementById('church-whatsapp'),
                redes: document.getElementById('church-redes'),
            }
        };

        // --- FUNÇÕES DE UI ---

        const UI = {
            showLoading: (message) => {
// ... existing code ... -->
            },
            showModal: (id) => document.getElementById(id)?.classList.replace('hidden', 'flex'),
            hideModal: (id) => document.getElementById(id)?.classList.replace('flex', 'hidden'),
            setupConfirmModal: ({ title, message, actionText, actionClass, onConfirm, requiresPassword = false, showCancelButton = true }) => {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                const actionBtn = document.getElementById('confirm-action-btn');
                actionBtn.textContent = actionText;
                actionBtn.className = `px-6 py-2 rounded-md text-white font-semibold transition ${actionClass}`;
                
                const passwordContainer = document.getElementById('password-field-container');
                const passwordInput = document.getElementById('admin-password');
                const passwordError = document.getElementById('password-error');
                
                if (requiresPassword) {
                    passwordContainer.classList.remove('hidden');
                    passwordInput.value = '';
                    passwordError.textContent = '';
                } else {
                    passwordContainer.classList.add('hidden');
                }

                const cancelBtn = document.getElementById('cancel-action-btn');
                cancelBtn.style.display = showCancelButton ? 'inline-block' : 'none';

                actionBtn.onclick = () => {
                    if (requiresPassword) {
                        if (passwordInput.value === ADMIN_PASSWORD) {
                            onConfirm();
                            UI.hideModal('confirm-modal');
                        } else {
                            passwordError.textContent = 'Senha incorreta.';
                        }
                    } else {
                        onConfirm();
                        UI.hideModal('confirm-modal');
                    }
                };

                if (showCancelButton) {
                    cancelBtn.onclick = () => UI.hideModal('confirm-modal');
                }
                UI.showModal('confirm-modal');
            }
        };

        // --- LÓGICA DO MAPA ---
        
        const MapLogic = {
            redrawAllMarkers: () => {
                churchLayer.clearLayers();
                allMarkers = [];
                displayedChurches.forEach(church => {
                    const marker = L.marker(church.coords, { icon: churchIcon }).addTo(churchLayer);
                    marker.bindPopup(MapLogic.createPopupContent(church));
                    marker.churchId = church.id;
                    allMarkers.push(marker);
                });
                UI.updateChurchCount();
            },
            createPopupContent: (church) => {
                let content = `<h3>${church.nome}</h3>`;
                if (church.pastor) content += `<p><strong>Líder:</strong> ${church.pastor}</p>`;
                if (church.endereco) content += `<p><strong>Endereço:</strong> ${church.endereco}</p>`;
                
                if (church.horarios && church.horarios.length > 0) {
                    let horariosHtml = "<strong>Horários:</strong><br>";
                    DIAS_SEMANA.forEach(dia => {
                        const atividades = church.horarios.filter(h => h.dia === dia);
                        if (atividades.length > 0) {
                            horariosHtml += `&bull; ${dia}: ${atividades.map(a => `${a.horaInicio}${a.horaFim ? ` - ${a.horaFim}`: ''} (${a.desc})`).join(', ')}<br>`;
                        }
                    });
                    content += `<p>${horariosHtml}</p>`;
                }

                if (church.contato) content += `<p><i class="fa fa-phone mr-2 text-gray-500"></i>${church.contato}</p>`;
                if (church.whatsapp) content += `<p><i class="fab fa-whatsapp mr-2 text-green-500"></i>${church.whatsapp}</p>`;
                if (church.redes_sociais) content += `<p><a href="${church.redes_sociais}" target="_blank" class="text-blue-600 hover:underline"><i class="fa fa-globe mr-2"></i>Visitar Rede Social</a></p>`;
                
                content += `<div class="mt-4 pt-2 border-t flex space-x-2">
                    <button class="popup-edit-btn text-xs bg-yellow-400 text-yellow-900 font-semibold py-1 px-3 rounded hover:bg-yellow-500" data-id="${church.id}">Editar</button>
                    <button class="popup-delete-btn text-xs bg-red-500 text-white font-semibold py-1 px-3 rounded hover:bg-red-600" data-id="${church.id}" data-name="${church.nome.replace(/"/g, '&quot;')}">Excluir</button>
                </div>`;
                return content;
            },
            setLocationOnMap: (lat, lng, zoom = 18) => {
                DOMElements.fields.lat.value = lat.toFixed(6);
                DOMElements.fields.lng.value = lng.toFixed(6);
                if (tempMarker) map.removeLayer(tempMarker);
                const latLng = [lat, lng];
                tempMarker = L.marker(latLng, { icon: tempIcon }).addTo(map);
                map.setView(latLng, zoom);
                DOMElements.coordsInfo.innerHTML = '<i class="fa fa-check-circle text-green-500 mr-2"></i>Localização selecionada no mapa!';
            },
            findUserLocation: () => {
                if (navigator.geolocation) {
                    UI.showLoading('Obtendo sua localização...');
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            map.setView([latitude, longitude], 15);
                            L.marker([latitude, longitude]).addTo(map)
                                .bindPopup("Você está aqui!").openPopup();
                            UI.hideLoading();
                        },
                        () => {
                            UI.hideLoading();
                            UI.setupConfirmModal({
                                title: 'Erro de Localização',
                                message: 'Não foi possível obter sua localização. Verifique as permissões do seu navegador.',
                                actionText: 'OK',
                                actionClass: 'bg-red-600 hover:bg-red-700',
                                onConfirm: () => {},
                                showCancelButton: false
                            });
                        }
                    );
                } else {
                    UI.setupConfirmModal({
                        title: 'Erro de Compatibilidade',
                        message: 'A geolocalização não é suportada por este navegador.',
                        actionText: 'OK',
                        actionClass: 'bg-red-600 hover:bg-red-700',
                        onConfirm: () => {},
                        showCancelButton: false
                    });
                }
            }
        };

        // --- LÓGICA DO FORMULÁRIO ---

        const FormLogic = {
            reset: () => {
                editingId = null;
                currentStreet = '';
                DOMElements.form.reset();
                DOMElements.gmapsUrlInput.value = '';
                DIAS_SEMANA.forEach(dia => {
                    const diaId = dia.toLowerCase();
                    document.getElementById(`check-${diaId}`).checked = false;
                    document.getElementById(`fields-${diaId}`).classList.remove('active');
                });
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
                DOMElements.coordsInfo.innerHTML = '<i class="fa fa-map-pin mr-2"></i>Clique no mapa ou use o CEP para localizar.';
                UI.showMessage(DOMElements.messageArea, '');
                UI.showMessage(DOMElements.importMessageArea, '');
                UI.showMessage(DOMElements.cepMessageArea, '');

                DOMElements.panelTitle.textContent = 'Adicionar Nova Igreja';
                DOMElements.saveBtn.textContent = 'Adicionar Igreja';
                DOMElements.saveBtn.className = 'w-full bg-blue-600 text-white py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition';
                DOMElements.cancelEditBtn.style.display = 'none';
            },
            startEdit: (id) => {
                const church = allChurches.find(c => c.id === id);
                if (!church) return;
                
                FormLogic.reset();
                editingId = id;
                
                DOMElements.fields.name.value = church.nome || '';
                DOMElements.fields.pastor.value = church.pastor || '';
                DOMElements.fields.bairro.value = church.bairro || '';
                DOMElements.fields.endereco.value = church.endereco || '';
                DOMElements.fields.contato.value = church.contato || '';
                DOMElements.fields.whatsapp.value = church.whatsapp || '';
                DOMElements.fields.redes.value = church.redes_sociais || '';
                DOMElements.fields.lat.value = church.coords[0];
                DOMElements.fields.lng.value = church.coords[1];

                (church.horarios || []).forEach(h => {
                    const diaId = h.dia.toLowerCase();
                    document.getElementById(`check-${diaId}`).checked = true;
                    const fieldsDiv = document.getElementById(`fields-${diaId}`);
                    fieldsDiv.classList.add('active');
                    fieldsDiv.querySelector(`#hora-inicio-${diaId}`).value = h.horaInicio || '';
                    fieldsDiv.querySelector(`#hora-fim-${diaId}`).value = h.horaFim || '';
                    fieldsDiv.querySelector(`#desc-${diaId}`).value = h.desc || '';
                });

                DOMElements.panelTitle.textContent = 'Editar Igreja';
                DOMElements.saveBtn.textContent = 'Salvar Alterações';
                DOMElements.saveBtn.className = 'w-full bg-yellow-500 text-white py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-400 transition';
                DOMElements.cancelEditBtn.style.display = 'block';
                map.closePopup();
                UI.openPanel();
            },
            save: async () => {
                if (!DOMElements.fields.name.value || !DOMElements.fields.lat.value || !DOMElements.fields.lng.value) {
                    UI.showMessage(DOMElements.messageArea, 'Nome e localização são obrigatórios.', true);
                    return;
                }
                const horarios = [];
                DIAS_SEMANA.forEach(dia => {
                    const diaId = dia.toLowerCase();
                    if(document.getElementById(`check-${diaId}`).checked) {
                        horarios.push({
                            dia: dia,
                            horaInicio: document.getElementById(`hora-inicio-${diaId}`).value,
                            horaFim: document.getElementById(`hora-fim-${diaId}`).value,
                            desc: document.getElementById(`desc-${diaId}`).value
                        });
                    }
                });
                
                const churchData = {
                    nome: DOMElements.fields.name.value,
                    pastor: DOMElements.fields.pastor.value,
                    bairro: DOMElements.fields.bairro.value,
                    endereco: DOMElements.fields.endereco.value,
                    horarios: horarios,
                    contato: DOMElements.fields.contato.value,
                    whatsapp: DOMElements.fields.whatsapp.value,
                    redes_sociais: DOMElements.fields.redes.value,
                    coords: [parseFloat(DOMElements.fields.lat.value), parseFloat(DOMElements.fields.lng.value)]
                };

                DOMElements.saveBtn.textContent = 'Salvando...';
                DOMElements.saveBtn.disabled = true;

                try {
                    if (editingId) {
                        await setDoc(doc(db, `artifacts/${appId}/public/data/igrejas`, editingId), churchData);
                    } else {
                        await addDoc(igrejasCollectionRef, churchData);
                    }
                    FormLogic.reset();
                    UI.closePanel();
                } catch (error) {
                    console.error("Erro ao salvar:", error);
                    UI.showMessage(DOMElements.messageArea, 'Erro ao salvar. Tente novamente.', true);
                } finally {
                    DOMElements.saveBtn.disabled = false;
                }
            },
            setupHorarios: () => {
                const timeOptions = (() => { let opts = '<option value="">--:--</option>'; for (let h=0;h<24;h++) for(let m=0;m<60;m+=30) {const t=`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; opts+=`<option value="${t}">${t}</option>`;} return opts; })();
                
                DIAS_SEMANA.forEach(dia => {
                    const diaId = dia.toLowerCase();
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'bg-gray-50 p-3 rounded-md';
                    dayDiv.innerHTML = `
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="check-${diaId}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-3 text-sm font-medium text-gray-800">${dia}</span>
                        </label>
                        <div class="schedule-day-fields mt-2 space-y-2 pl-7" id="fields-${diaId}">
                            <input type="text" id="desc-${diaId}" placeholder="Descrição (Ex: Culto, Missa)" class="block w-full border-gray-300 rounded-md shadow-sm sm:text-sm">
                            <div class="flex items-center space-x-2 text-sm">
                                <select id="hora-inicio-${diaId}" class="block w-full border-gray-300 rounded-md shadow-sm sm:text-sm">${timeOptions}</select>
                                <span>até</span>
                                <select id="hora-fim-${diaId}" class="block w-full border-gray-300 rounded-md shadow-sm sm:text-sm">${timeOptions}</select>
                            </div>
                        </div>
                    `;
                    DOMElements.horariosContainer.appendChild(dayDiv);
                    
                    const checkbox = dayDiv.querySelector(`#check-${diaId}`);
                    const fieldsDiv = dayDiv.querySelector(`#fields-${diaId}`);
                    checkbox.addEventListener('change', () => {
                        fieldsDiv.classList.toggle('active', checkbox.checked);
                    });
                });
            }
        };

        // --- FUNÇÕES DE API EXTERNA ---

        const API = {
            fetchCEP: async (cep) => {
                UI.showMessage(DOMElements.cepMessageArea, 'Buscando CEP...');
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();
                    if (data.erro) {
                        UI.showMessage(DOMElements.cepMessageArea, 'CEP não encontrado.', true);
                        currentStreet = '';
                    } else {
                        currentStreet = data.logradouro || '';
                        DOMElements.fields.endereco.value = currentStreet;
                        DOMElements.fields.bairro.value = data.bairro || '';
                        DOMElements.fields.numero.value = '';
                        DOMElements.fields.numero.focus();
                        UI.showMessage(DOMElements.cepMessageArea, 'CEP encontrado!');
                        API.geocodeAddress(`${currentStreet}, ${data.bairro}, Blumenau`);
                    }
                } catch {
                    UI.showMessage(DOMElements.cepMessageArea, 'Erro ao buscar CEP.', true);
                    currentStreet = '';
                }
            },
            geocodeAddress: async (address) => {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const { lat, lon } = data[0];
                        MapLogic.setLocationOnMap(parseFloat(lat), parseFloat(lon));
                    }
                } catch (error) {
                    console.error("Erro no geocode:", error);
                }
            },
            reverseGeocode: async (lat, lon) => {
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data && data.address) {
                        const addr = data.address;
                        const rua = addr.road || '';
                        const numero = addr.house_number || '';
                        const bairro = addr.suburb || addr.city_district || '';
                        DOMElements.fields.bairro.value = bairro;
                        currentStreet = rua;
                        DOMElements.fields.numero.value = numero;
                        DOMElements.fields.endereco.value = `${rua}, ${numero}`;
                    }
                } catch (error) {
                    console.error("Erro no reverse geocode:", error);
                }
            }
        };

        // --- FUNÇÕES AVANÇADAS (ADMIN) ---

        const Admin = {
            confirmDelete: (id, name) => {
                UI.setupConfirmModal({
                    title: 'Confirmar Exclusão',
                    message: `Tem certeza que deseja excluir a igreja "${name}"? Esta ação não pode ser desfeita.`,
                    actionText: 'Sim, Excluir',
                    actionClass: 'bg-red-600 hover:bg-red-700',
                    onConfirm: async () => {
                        try {
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/igrejas`, id));
                        } catch (error) { console.error("Erro ao excluir:", error); }
                    }
                });
            },
            confirmClearMap: () => {
                UI.setupConfirmModal({
                    title: 'Limpar Todo o Mapa',
                    message: 'Esta ação é irreversível e apagará TODAS as igrejas do mapa. Para confirmar, digite a senha de administrador.',
                    actionText: 'Confirmar Limpeza',
                    actionClass: 'bg-red-600 hover:bg-red-700',
                    requiresPassword: true,
                    onConfirm: Admin.clearAllData
                });
            },
            clearAllData: async () => {
                if (allChurches.length === 0) return;
                UI.showLoading('Limpando todos os dados...');
                const batch = writeBatch(db);
                allChurches.forEach(church => {
                    batch.delete(doc(db, `artifacts/${appId}/public/data/igrejas`, church.id));
                });
                try {
                    await batch.commit();
                } catch (error) {
                    console.error("Erro ao limpar mapa:", error);
                } finally {
                    UI.hideLoading();
                }
            },
            confirmScanMap: () => {
                UI.setupConfirmModal({
                    title: 'Escanear Mapa',
                    message: 'Isso buscará por locais de culto no OpenStreetMap na área visível do mapa e os adicionará se não existirem. Requer senha de administrador.',
                    actionText: 'Iniciar Escaneamento',
                    actionClass: 'bg-blue-600 hover:bg-blue-700',
                    requiresPassword: true,
                    onConfirm: Admin.scanMapForChurches
                });
            },
            scanMapForChurches: async () => {
                UI.showLoading('Escaneando a área do mapa...');
                const bounds = map.getBounds();
                const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
                const query = `[out:json][timeout:30];
                    area[name="Blumenau"][boundary="administrative"]->.searchArea;
                    (
                        node["amenity"="place_of_worship"](area.searchArea)(${bbox});
                        way["amenity"="place_of_worship"](area.searchArea)(${bbox});
                    );
                    out center;`;
                const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    let newChurchesCount = 0;
                    const batch = writeBatch(db);

                    for (const element of data.elements) {
                        const lat = element.center ? element.center.lat : element.lat;
                        const lon = element.center ? element.center.lon : element.lon;
                        const nome = element.tags.name || "Igreja sem nome";

                        const isDuplicate = allChurches.some(church =>
                            (Math.abs(church.coords[0] - lat) < 0.0001 && Math.abs(church.coords[1] - lon) < 0.0001)
                        );
                        
                        if (!isDuplicate) {
                            newChurchesCount++;
                            const newDocRef = doc(igrejasCollectionRef);
                            batch.set(newDocRef, {
                                nome: nome, coords: [lat, lon], bairro: '', endereco: '', pastor: '',
                                horarios: [], contato: '', whatsapp: '', redes_sociais: ''
                            });
                        }
                    }
                    if (newChurchesCount > 0) {
                        await batch.commit();
                        UI.setupConfirmModal({
                            title: 'Escaneamento Concluído',
                            message: `${newChurchesCount} nova(s) igreja(s) foram adicionada(s).`,
                            actionText: 'OK',
                            actionClass: 'bg-blue-600 hover:bg-blue-700',
                            onConfirm: () => {},
                            showCancelButton: false
                        });
                    } else {
                        UI.setupConfirmModal({
                            title: 'Escaneamento Concluído',
                            message: 'Nenhuma igreja nova foi encontrada na área visível do mapa.',
                            actionText: 'OK',
                            actionClass: 'bg-blue-600 hover:bg-blue-700',
                            onConfirm: () => {},
                            showCancelButton: false
                        });
                    }
                } catch(e) {
                    UI.setupConfirmModal({
                        title: 'Erro',
                        message: 'Ocorreu um erro ao escanear o mapa. Tente novamente.',
                        actionText: 'OK',
                        actionClass: 'bg-red-600 hover:bg-red-700',
                        onConfirm: () => {},
                        showCancelButton: false
                    });
                    console.error(e);
                } finally {
                    UI.hideLoading();
                }
            }
        };
        
// ... existing code ... -->

